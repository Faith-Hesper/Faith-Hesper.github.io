define(["./Cartesian3-e96ac170","./Transforms-b1e48e05","./IntersectionTests-39c3b1c1","./TerrainEncoding-68597868","./GeographicProjection-868b0b16","./defined-64766648","./Ellipsoid-fa58f06f","./Math-56779564","./Matrix2-e52b9454","./IndexDatatype-ed8b21cb","./PixelFormat-5109196d","./Resource-be841477","./defaultValue-9f6a6288","./createTaskProcessorWorker-03824364","./Texture-3b0b528f","./WebGLConstants-7f557f93","./ComponentDatatype-63fd8cd4","./Geometry-dd0ae099","./RuntimeError-cfbf2bc8","./Matrix3-59918a96","./Cartesian2-0a34ed75","./AttributeCompression-44abee07","./combine-ac72e009","./defer-7878b392"],(function(e,t,r,n,i,a,o,s,f,u,d,c,l,y,h,p,g,A,x,D,m,v,b,E){"use strict";function _(e,t,r,n,i,a,o){this.provider=e,this.message=t,this.x=r,this.y=n,this.level=i,this.timesRetried=l.defaultValue(a,0),this.retry=!1,this.error=o}_.reportError=function(e,t,r,n,i,o,s,f){let u=e;return a.defined(e)?(u.provider=t,u.message=n,u.x=i,u.y=o,u.level=s,u.retry=!1,u.error=f,++u.timesRetried):u=new _(t,n,i,o,s,0,f),a.defined(r)&&r.numberOfListeners>0?r.raiseEvent(u):a.defined(t)&&console.log(`An error occurred in "${t.constructor.name}": ${y.formatError(n)}`),u},_.reportSuccess=function(e){a.defined(e)&&(e.timesRetried=-1)};const I={STREAM_DRAW:p.WebGLConstants.STREAM_DRAW,STATIC_DRAW:p.WebGLConstants.STATIC_DRAW,DYNAMIC_DRAW:p.WebGLConstants.DYNAMIC_DRAW,validate:function(e){return e===I.STREAM_DRAW||e===I.STATIC_DRAW||e===I.DYNAMIC_DRAW}};var B=Object.freeze(I);function T(e){const t=(e=l.defaultValue(e,l.defaultValue.EMPTY_OBJECT)).context._gl,r=e.bufferTarget,n=e.typedArray;let i=e.sizeInBytes;const o=e.usage,s=a.defined(n);s&&(i=n.byteLength);const f=t.createBuffer();t.bindBuffer(r,f),t.bufferData(r,s?n:i,o),t.bindBuffer(r,null),this._id=h.createGuid(),this._gl=t,this._webgl2=e.context._webgl2,this._bufferTarget=r,this._sizeInBytes=i,this._usage=o,this._buffer=f,this.vertexArrayDestroyable=!0}function S(e,t,r,n){const i=a.defined(t.vertexBuffer),o=a.defined(t.value),s=t.value?t.value.length:t.componentsPerAttribute,f={index:l.defaultValue(t.index,r),enabled:l.defaultValue(t.enabled,!0),vertexBuffer:t.vertexBuffer,value:o?t.value.slice(0):void 0,componentsPerAttribute:s,componentDatatype:l.defaultValue(t.componentDatatype,g.ComponentDatatype.FLOAT),normalize:l.defaultValue(t.normalize,!1),offsetInBytes:l.defaultValue(t.offsetInBytes,0),strideInBytes:l.defaultValue(t.strideInBytes,0),instanceDivisor:l.defaultValue(t.instanceDivisor,0)};if(i)f.vertexAttrib=function(e){const t=this.index;e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer._getBuffer()),e.vertexAttribPointer(t,this.componentsPerAttribute,this.componentDatatype,this.normalize,this.strideInBytes,this.offsetInBytes),e.enableVertexAttribArray(t),this.instanceDivisor>0&&(n.glVertexAttribDivisor(t,this.instanceDivisor),n._vertexAttribDivisors[t]=this.instanceDivisor,n._previousDrawInstanced=!0)},f.disableVertexAttribArray=function(e){e.disableVertexAttribArray(this.index),this.instanceDivisor>0&&n.glVertexAttribDivisor(r,0)};else{switch(f.componentsPerAttribute){case 1:f.vertexAttrib=function(e){e.vertexAttrib1fv(this.index,this.value)};break;case 2:f.vertexAttrib=function(e){e.vertexAttrib2fv(this.index,this.value)};break;case 3:f.vertexAttrib=function(e){e.vertexAttrib3fv(this.index,this.value)};break;case 4:f.vertexAttrib=function(e){e.vertexAttrib4fv(this.index,this.value)}}f.disableVertexAttribArray=function(e){}}e.push(f)}function C(e,t,r){for(let r=0;r<t.length;++r){const n=t[r];n.enabled&&n.vertexAttrib(e)}a.defined(r)&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r._getBuffer())}function R(e){const t=(e=l.defaultValue(e,l.defaultValue.EMPTY_OBJECT)).context,r=t._gl,n=e.attributes,i=e.indexBuffer;let o;const s=[];let f,u=1,d=!1,c=!1,y=n.length;for(o=0;o<y;++o)S(s,n[o],o,t);for(y=s.length,o=0;o<y;++o){const e=s[o];if(a.defined(e.vertexBuffer)&&0===e.instanceDivisor){const t=e.strideInBytes||e.componentsPerAttribute*g.ComponentDatatype.getSizeInBytes(e.componentDatatype);u=e.vertexBuffer.sizeInBytes/t;break}}for(o=0;o<y;++o)s[o].instanceDivisor>0&&(d=!0),a.defined(s[o].value)&&(c=!0);t.vertexArrayObject&&(f=t.glCreateVertexArray(),t.glBindVertexArray(f),C(r,s,i),t.glBindVertexArray(null)),this._numberOfVertices=u,this._hasInstancedAttributes=d,this._hasConstantAttributes=c,this._context=t,this._gl=r,this._vao=f,this._attributes=s,this._indexBuffer=i}function V(e){return e.values.length/e.componentsPerAttribute}function w(e){return g.ComponentDatatype.getSizeInBytes(e.componentDatatype)*e.componentsPerAttribute}T.createVertexBuffer=function(e){return new T({context:e.context,bufferTarget:p.WebGLConstants.ARRAY_BUFFER,typedArray:e.typedArray,sizeInBytes:e.sizeInBytes,usage:e.usage})},T.createIndexBuffer=function(e){const t=e.context,r=e.indexDatatype,n=u.IndexDatatype.getSizeInBytes(r),i=new T({context:t,bufferTarget:p.WebGLConstants.ELEMENT_ARRAY_BUFFER,typedArray:e.typedArray,sizeInBytes:e.sizeInBytes,usage:e.usage}),a=i.sizeInBytes/n;return Object.defineProperties(i,{indexDatatype:{get:function(){return r}},bytesPerIndex:{get:function(){return n}},numberOfIndices:{get:function(){return a}}}),i},Object.defineProperties(T.prototype,{sizeInBytes:{get:function(){return this._sizeInBytes}},usage:{get:function(){return this._usage}}}),T.prototype._getBuffer=function(){return this._buffer},T.prototype.copyFromArrayView=function(e,t){t=l.defaultValue(t,0);const r=this._gl,n=this._bufferTarget;r.bindBuffer(n,this._buffer),r.bufferSubData(n,t,e),r.bindBuffer(n,null)},T.prototype.copyFromBuffer=function(e,t,r,n){const i=p.WebGLConstants.COPY_READ_BUFFER,a=p.WebGLConstants.COPY_WRITE_BUFFER,o=this._gl;o.bindBuffer(a,this._buffer),o.bindBuffer(i,e._buffer),o.copyBufferSubData(i,a,t,r,n),o.bindBuffer(a,null),o.bindBuffer(i,null)},T.prototype.getBufferData=function(e,t,r,n){t=l.defaultValue(t,0),r=l.defaultValue(r,0);const i=this._gl,a=p.WebGLConstants.COPY_READ_BUFFER;i.bindBuffer(a,this._buffer),i.getBufferSubData(a,t,e,r,n),i.bindBuffer(a,null)},T.prototype.isDestroyed=function(){return!1},T.prototype.destroy=function(){return this._gl.deleteBuffer(this._buffer),h.destroyObject(this)},R.fromGeometry=function(e){const t=(e=l.defaultValue(e,l.defaultValue.EMPTY_OBJECT)).context,r=l.defaultValue(e.geometry,l.defaultValue.EMPTY_OBJECT),n=l.defaultValue(e.bufferUsage,B.DYNAMIC_DRAW),i=l.defaultValue(e.attributeLocations,l.defaultValue.EMPTY_OBJECT),o=l.defaultValue(e.interleave,!1),f=e.vertexArrayAttributes;let d,c,y;const h=a.defined(f)?f:[],p=r.attributes;if(o){const e=function(e){let t,r,n;const i=[];for(r in e)e.hasOwnProperty(r)&&a.defined(e[r])&&a.defined(e[r].values)&&(i.push(r),e[r].componentDatatype===g.ComponentDatatype.DOUBLE&&(e[r].componentDatatype=g.ComponentDatatype.FLOAT,e[r].values=g.ComponentDatatype.createTypedArray(g.ComponentDatatype.FLOAT,e[r].values)));let o;const s=i.length;if(s>0)for(o=V(e[i[0]]),t=1;t<s;++t){const r=V(e[i[t]]);if(r!==o)throw new x.RuntimeError(`Each attribute list must have the same number of vertices.  Attribute ${i[t]} has a different number of vertices (${r.toString()}) than attribute ${i[0]} (${o.toString()}).`)}i.sort((function(t,r){return g.ComponentDatatype.getSizeInBytes(e[r].componentDatatype)-g.ComponentDatatype.getSizeInBytes(e[t].componentDatatype)}));let f=0;const u={};for(t=0;t<s;++t)r=i[t],n=e[r],u[r]=f,f+=w(n);if(f>0){const a=g.ComponentDatatype.getSizeInBytes(e[i[0]].componentDatatype),d=f%a;0!==d&&(f+=a-d);const c=new ArrayBuffer(o*f),l={};for(t=0;t<s;++t){r=i[t];const n=g.ComponentDatatype.getSizeInBytes(e[r].componentDatatype);l[r]={pointer:g.ComponentDatatype.createTypedArray(e[r].componentDatatype,c),index:u[r]/n,strideInComponentType:f/n}}for(t=0;t<o;++t)for(let a=0;a<s;++a){r=i[a],n=e[r];const o=n.values,s=l[r],f=s.pointer,u=n.componentsPerAttribute;for(let e=0;e<u;++e)f[s.index+e]=o[t*u+e];s.index+=s.strideInComponentType}return{buffer:c,offsetsInBytes:u,vertexSizeInBytes:f}}}(p);if(a.defined(e)){y=T.createVertexBuffer({context:t,typedArray:e.buffer,usage:n});const r=e.offsetsInBytes,o=e.vertexSizeInBytes;for(d in p)p.hasOwnProperty(d)&&a.defined(p[d])&&(c=p[d],a.defined(c.values)?h.push({index:i[d],vertexBuffer:y,componentDatatype:c.componentDatatype,componentsPerAttribute:c.componentsPerAttribute,normalize:c.normalize,offsetInBytes:r[d],strideInBytes:o}):h.push({index:i[d],value:c.value,componentDatatype:c.componentDatatype,normalize:c.normalize}))}}else for(d in p)if(p.hasOwnProperty(d)&&a.defined(p[d])){c=p[d];let e=c.componentDatatype;e===g.ComponentDatatype.DOUBLE&&(e=g.ComponentDatatype.FLOAT),y=void 0,a.defined(c.values)&&(y=T.createVertexBuffer({context:t,typedArray:g.ComponentDatatype.createTypedArray(e,c.values),usage:n})),h.push({index:i[d],vertexBuffer:y,value:c.value,componentDatatype:e,componentsPerAttribute:c.componentsPerAttribute,normalize:c.normalize})}let D;const m=r.indices;return a.defined(m)&&(D=A.Geometry.computeNumberOfVertices(r)>=s.CesiumMath.SIXTY_FOUR_KILOBYTES&&t.elementIndexUint?T.createIndexBuffer({context:t,typedArray:new Uint32Array(m),usage:n,indexDatatype:u.IndexDatatype.UNSIGNED_INT}):T.createIndexBuffer({context:t,typedArray:new Uint16Array(m),usage:n,indexDatatype:u.IndexDatatype.UNSIGNED_SHORT})),new R({context:t,attributes:h,indexBuffer:D})},Object.defineProperties(R.prototype,{numberOfAttributes:{get:function(){return this._attributes.length}},numberOfVertices:{get:function(){return this._numberOfVertices}},indexBuffer:{get:function(){return this._indexBuffer}}}),R.prototype.getAttribute=function(e){return this._attributes[e]},R.prototype._bind=function(){a.defined(this._vao)?(this._context.glBindVertexArray(this._vao),this._context.instancedArrays&&function(e){const t=e._context,r=e._hasInstancedAttributes;if(!r&&!t._previousDrawInstanced)return;t._previousDrawInstanced=r;const n=t._vertexAttribDivisors,i=e._attributes,a=h.ContextLimits.maximumVertexAttributes;let o;if(r){const e=i.length;for(o=0;o<e;++o){const e=i[o];if(e.enabled){const r=e.instanceDivisor,i=e.index;r!==n[i]&&(t.glVertexAttribDivisor(i,r),n[i]=r)}}}else for(o=0;o<a;++o)n[o]>0&&(t.glVertexAttribDivisor(o,0),n[o]=0)}(this),this._hasConstantAttributes&&function(e,t){const r=e._attributes,n=r.length;for(let e=0;e<n;++e){const n=r[e];n.enabled&&a.defined(n.value)&&n.vertexAttrib(t)}}(this,this._gl)):C(this._gl,this._attributes,this._indexBuffer)},R.prototype._unBind=function(){if(a.defined(this._vao))this._context.glBindVertexArray(null);else{const e=this._attributes,t=this._gl;for(let r=0;r<e.length;++r){const n=e[r];n.enabled&&n.disableVertexAttribArray(t)}this._indexBuffer&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}},R.prototype.isDestroyed=function(){return!1},R.prototype.destroy=function(){const e=this._attributes;for(let t=0;t<e.length;++t){const r=e[t].vertexBuffer;a.defined(r)&&!r.isDestroyed()&&r.vertexArrayDestroyable&&r.destroy()}const t=this._indexBuffer;return a.defined(t)&&!t.isDestroyed()&&t.vertexArrayDestroyable&&t.destroy(),a.defined(this._vao)&&this._context.glDeleteVertexArray(this._vao),h.destroyObject(this)};var M=Object.freeze({UNLOADED:0,TRANSITIONING:1,RECEIVED:2,TEXTURE_LOADED:3,READY:4,FAILED:5,INVALID:6,PLACEHOLDER:7});var N=Object.freeze({START:0,LOADING:1,DONE:2,FAILED:3});const O={MORPHING:0,COLUMBUS_VIEW:1,SCENE2D:2,SCENE3D:3,getMorphTime:function(e){return e===O.SCENE3D?1:e!==O.MORPHING?0:void 0}};var F=Object.freeze(O);var L=Object.freeze({FAILED:0,UNLOADED:1,RECEIVING:2,RECEIVED:3,TRANSFORMING:4,TRANSFORMED:5,READY:6});function P(){this.imagery=[],this.waterMaskTexture=void 0,this.waterMaskTranslationAndScale=new f.Cartesian4(0,0,1,1),this.terrainData=void 0,this.vertexArray=void 0,this.tileBoundingRegion=void 0,this.occludeePointInScaledSpace=new e.Cartesian3,this.boundingVolumeSourceTile=void 0,this.boundingVolumeIsFromMesh=!1,this.terrainState=L.UNLOADED,this.mesh=void 0,this.fill=void 0,this.pickBoundingSphere=new t.BoundingSphere,this.surfaceShader=void 0,this.isClipped=!0,this.clippedByBoundaries=!1}Object.defineProperties(P.prototype,{eligibleForUnloading:{get:function(){const e=this.terrainState;let t=!(e===L.RECEIVING||e===L.TRANSFORMING);const r=this.imagery;for(let e=0,n=r.length;t&&e<n;++e){const n=r[e];t=!a.defined(n.loadingImagery)||n.loadingImagery.state!==M.TRANSITIONING}return t}},renderedMesh:{get:function(){return a.defined(this.vertexArray)?this.mesh:a.defined(this.fill)?this.fill.mesh:void 0}}});const G=new o.Cartographic;function k(t,r,n,i,o,s){let f=t.getExaggeratedPosition(i,o,s);if(a.defined(r)&&r!==F.SCENE3D){const t=n.ellipsoid.cartesianToCartographic(f,G);f=n.project(t,s),f=e.Cartesian3.fromElements(f.z,f.x,f.y,s)}return f}const U=new e.Cartesian3,z=new e.Cartesian3,W=new e.Cartesian3;function Y(e,t,r,i){const a=e.renderedMesh,o=a.vertices,s=a.encoding,f=o.length/s.stride;let u=n.TerrainEncoding.clone(s);u.hasGeodeticSurfaceNormals=t,u=n.TerrainEncoding.clone(u);const d=u.stride,c=new Float32Array(f*d);t?s.addGeodeticSurfaceNormals(o,c,r):s.removeGeodeticSurfaceNormals(o,c),a.vertices=c,a.stride=d;a!==e.mesh?(P._freeVertexArray(e.fill.vertexArray),e.fill.vertexArray=P._createVertexArrayForMesh(i.context,a)):(P._freeVertexArray(e.vertexArray),e.vertexArray=P._createVertexArrayForMesh(i.context,a)),P._freeVertexArray(e.wireframeVertexArray),e.wireframeVertexArray=void 0}P.prototype.pick=function(e,t,n,i,o){const s=this.renderedMesh;if(!a.defined(s))return;const f=s.vertices,u=s.indices,d=s.encoding,c=u.length;let l=Number.MAX_VALUE;for(let o=0;o<c;o+=3){const s=u[o],c=u[o+1],y=u[o+2],h=k(d,t,n,f,s,U),p=k(d,t,n,f,c,z),g=k(d,t,n,f,y,W),A=r.IntersectionTests.rayTriangleParametric(e,h,p,g,i);a.defined(A)&&A<l&&A>=0&&(l=A)}return l!==Number.MAX_VALUE?r.Ray.getPoint(e,l,o):void 0},P.prototype.freeResources=function(){a.defined(this.waterMaskTexture)&&(--this.waterMaskTexture.referenceCount,0===this.waterMaskTexture.referenceCount&&this.waterMaskTexture.destroy(),this.waterMaskTexture=void 0),this.terrainData=void 0,this.terrainState=L.UNLOADED,this.mesh=void 0,this.fill=this.fill&&this.fill.destroy();const e=this.imagery;for(let t=0,r=e.length;t<r;++t)e[t].freeResources();this.imagery.length=0,this.freeVertexArray()},P.prototype.freeVertexArray=function(){P._freeVertexArray(this.vertexArray),this.vertexArray=void 0,P._freeVertexArray(this.wireframeVertexArray),this.wireframeVertexArray=void 0},P.initialize=function(e,t,r){let n=e.data;a.defined(n)||(n=e.data=new P),e.state===N.START&&(!function(e,t,r){let n=t.getTileDataAvailable(e.x,e.y,e.level);if(!a.defined(n)&&a.defined(e.parent)){const t=e.parent,r=t.data;a.defined(r)&&a.defined(r.terrainData)&&(n=r.terrainData.isChildAvailable(t.x,t.y,e.x,e.y))}!1===n&&(e.data.terrainState=L.FAILED);for(let n=0,i=r.length;n<i;++n){const i=r.get(n);i.show&&i._createTileImagerySkeletons(e,t)}}(e,t,r),e.state=N.LOADING)},P.processStateMachine=function(e,t,r,n,i,o,s){P.initialize(e,r,n);const u=e.data;if(e.state===N.LOADING&&function(e,t,r,n,i,o){const s=e.data,u=e.parent;if(s.terrainState===L.FAILED&&void 0!==u){void 0!==u.data&&void 0!==u.data.terrainData&&!1!==u.data.terrainData.canUpsample||P.processStateMachine(u,t,r,n,i,o,!0)}s.terrainState===L.FAILED&&function(e,t,r,n,i,o,s){const f=t.parent;if(!f)return void(t.state=N.FAILED);const u=f.data.terrainData,d=f.x,c=f.y,l=f.level;if(!a.defined(u))return;const y=u.upsample(n.tilingScheme,d,c,l,i,o,s);if(!a.defined(y))return;e.terrainState=L.RECEIVING,Promise.resolve(y).then((function(t){e.terrainData=t,e.terrainState=L.RECEIVED})).catch((function(){e.terrainState=L.FAILED}))}(s,e,0,r,e.x,e.y,e.level);s.terrainState===L.UNLOADED&&function(e,t,r,n,i){function o(t){e.terrainData=t,e.terrainState=L.RECEIVED,e.request=void 0}function s(a){if(e.request.state===c.RequestState.CANCELLED)return e.terrainData=void 0,e.terrainState=L.UNLOADED,void(e.request=void 0);e.terrainState=L.FAILED,e.request=void 0;const o=`Failed to obtain terrain tile X: ${r} Y: ${n} Level: ${i}. Error message: "${a}"`;t._requestError=_.reportError(t._requestError,t,t.errorEvent,o,r,n,i),t._requestError.retry&&f()}function f(){const f=new c.Request({throttle:!1,throttleByServer:!0,type:c.RequestType.TERRAIN});e.request=f;const u=t.requestTileGeometry(r,n,i,f);a.defined(u)?(e.terrainState=L.RECEIVING,Promise.resolve(u).then((function(e){o(e)})).catch((function(e){s(e)}))):(e.terrainState=L.UNLOADED,e.request=void 0)}f()}(s,r,e.x,e.y,e.level);s.terrainState===L.RECEIVED&&function(e,t,r,n,i,o){const s=r.tilingScheme,f=q;f.tilingScheme=s,f.x=n,f.y=i,f.level=o,f.exaggeration=t.terrainExaggeration,f.exaggerationRelativeHeight=t.terrainExaggerationRelativeHeight,f.throttle=!0;const u=e.terrainData,d=u.createMesh(f);if(!a.defined(d))return;e.terrainState=L.TRANSFORMING,Promise.resolve(d).then((function(t){e.mesh=t,e.terrainState=L.TRANSFORMED})).catch((function(){e.terrainState=L.FAILED}))}(s,t,r,e.x,e.y,e.level);s.terrainState===L.TRANSFORMED&&(!function(e,t,r,n,i,a,o){e.vertexArray=P._createVertexArrayForMesh(t,e.mesh),e.terrainState=L.READY,e.fill=e.fill&&e.fill.destroy(o)}(s,t.context,0,e.x,e.y,e.level,o),s.updateExaggeration(e,t,i));if(s.terrainState>=L.RECEIVED&&void 0===s.waterMaskTexture&&r.hasWaterMask){if(void 0!==s.terrainData.waterMask)!function(e,t){const r=t.terrainData.waterMask,n=function(e){let t=e.cache.tile_waterMaskData;if(!a.defined(t)){const r=h.Texture.create({context:e,pixelFormat:d.PixelFormat.LUMINANCE,pixelDatatype:d.PixelDatatype.UNSIGNED_BYTE,source:{arrayBufferView:new Uint8Array([255]),width:1,height:1}});r.referenceCount=1;t={allWaterTexture:r,sampler:new h.Sampler({wrapS:h.TextureWrap.CLAMP_TO_EDGE,wrapT:h.TextureWrap.CLAMP_TO_EDGE,minificationFilter:h.TextureMinificationFilter.LINEAR,magnificationFilter:h.TextureMagnificationFilter.LINEAR}),destroy:function(){this.allWaterTexture.destroy()}},e.cache.tile_waterMaskData=t}return t}(e);let i;const o=r.length;if(1===o){if(0===r[0])return;i=n.allWaterTexture}else{const t=Math.sqrt(o);i=h.Texture.create({context:e,pixelFormat:d.PixelFormat.LUMINANCE,pixelDatatype:d.PixelDatatype.UNSIGNED_BYTE,source:{width:t,height:t,arrayBufferView:r},sampler:n.sampler,flipY:!1}),i.referenceCount=0}++i.referenceCount,t.waterMaskTexture=i,f.Cartesian4.fromElements(0,0,1,1,t.waterMaskTranslationAndScale)}(t.context,s);else{const t=s._findAncestorTileWithTerrainData(e);a.defined(t)&&a.defined(t.data.waterMaskTexture)&&(s.waterMaskTexture=t.data.waterMaskTexture,++s.waterMaskTexture.referenceCount,s._computeWaterMaskTranslationAndScale(e,t,s.waterMaskTranslationAndScale))}}}(e,t,r,n,i,o),s||!u.terrainData)return;const l=e.renderable;e.renderable=a.defined(u.vertexArray);const y=u.terrainState===L.READY;e.upsampledFromParent=a.defined(u.terrainData)&&u.terrainData.wasCreatedByUpsampling();const p=u.processImagery(e,r,t);if(y&&p){const t=e._loadedCallbacks,r={};for(const n in t)t.hasOwnProperty(n)&&(t[n](e)||(r[n]=t[n]));e._loadedCallbacks=r,e.state=N.DONE}l&&(e.renderable=!0)},P.prototype.processImagery=function(e,t,r,n){const i=e.data;let o=e.upsampledFromParent,s=!1,f=!0;const u=i.imagery;let d,c;for(d=0,c=u.length;d<c;++d){const i=u[d];if(!a.defined(i.loadingImagery)){o=!1;continue}if(i.loadingImagery.state===M.PLACEHOLDER){const r=i.loadingImagery.imageryLayer,n=r.imageryProvider;if(r.ready&&(a.defined(n._ready)?n._ready:!a.defined(n.ready)||n.ready)){i.freeResources(),u.splice(d,1),r._createTileImagerySkeletons(e,t,d),--d,c=u.length;continue}o=!1}const l=i.processStateMachine(e,r,n);f=f&&l,s=s||l||a.defined(i.readyImagery),o=o&&a.defined(i.loadingImagery)&&(i.loadingImagery.state===M.FAILED||i.loadingImagery.state===M.INVALID)}return e.upsampledFromParent=o,e.renderable=e.renderable&&(s||f),f},P.prototype.addGeodeticSurfaceNormals=function(e,t){Y(this,!0,e,t)},P.prototype.removeGeodeticSurfaceNormals=function(e){Y(this,!1,void 0,e)},P.prototype.updateExaggeration=function(e,t,r){const n=this,i=n.renderedMesh;if(void 0===i)return;const a=t.terrainExaggeration,o=t.terrainExaggerationRelativeHeight,s=1!==a,f=i.encoding,u=f.exaggeration!==a,d=f.exaggerationRelativeHeight!==o;if(u||d){if(u)if(s&&!f.hasGeodeticSurfaceNormals){const r=e.tilingScheme.ellipsoid;n.addGeodeticSurfaceNormals(r,t)}else!s&&f.hasGeodeticSurfaceNormals&&n.removeGeodeticSurfaceNormals(t);if(f.exaggeration=a,f.exaggerationRelativeHeight=o,void 0!==r){r._tileToUpdateHeights.push(e);const t=e.customData,n=t.length;for(let e=0;e<n;e++){t[e].level=-1}}}};const q={tilingScheme:void 0,x:0,y:0,level:0,exaggeration:1,exaggerationRelativeHeight:0,throttle:!0};P._createVertexArrayForMesh=function(e,t){const r=t.vertices,n=T.createVertexBuffer({context:e,typedArray:r,usage:B.STATIC_DRAW}),i=t.encoding.getAttributes(n),o=t.indices.indexBuffers||{};let s=o[e.id];if(!a.defined(s)||s.isDestroyed()){const r=t.indices;s=T.createIndexBuffer({context:e,typedArray:r,usage:B.STATIC_DRAW,indexDatatype:u.IndexDatatype.fromSizeInBytes(r.BYTES_PER_ELEMENT)}),s.vertexArrayDestroyable=!1,s.referenceCount=1,o[e.id]=s,t.indices.indexBuffers=o}else++s.referenceCount;return new R({context:e,attributes:i,indexBuffer:s})},P._freeVertexArray=function(e){if(a.defined(e)){const t=e.indexBuffer;e.isDestroyed()||e.destroy(),a.defined(t)&&!t.isDestroyed()&&a.defined(t.referenceCount)&&(--t.referenceCount,0===t.referenceCount&&t.destroy())}},P.prototype._findAncestorTileWithTerrainData=function(e){let t=e.parent;for(;a.defined(t)&&(!a.defined(t.data)||!a.defined(t.data.terrainData)||t.data.terrainData.wasCreatedByUpsampling());)t=t.parent;return t},P.prototype._computeWaterMaskTranslationAndScale=function(e,t,r){const n=t.rectangle,i=e.rectangle,a=i.width,o=i.height,s=a/n.width,f=o/n.height;return r.x=s*(i.west-n.west)/a,r.y=f*(i.south-n.south)/o,r.z=s,r.w=f,r};let j=new i.GeographicProjection;const H={start:0,stop:0};function $(e,t){let r,n=t.length;for(let i=0;i<n&&(r=t[i].pick(e,3,j,!0),!a.defined(r));++i);return r}function J(e){let t=o.Ellipsoid.WGS84.cartesianToCartographic(e),r=s.CesiumMath.toDegrees(t.latitude);return{lng:s.CesiumMath.toDegrees(t.longitude),lat:r,height:t.height}}function X(e,t,n){let i=t.length;for(let o=0;o<i;o++){let i=t[o],s=i.boundingSphere;const f=r.IntersectionTests.raySphere(e,s,H);a.defined(f)&&(n[i.key]=i)}}return y.createTaskProcessorWorker((function(i,a){let o=i.tileDatas.boundingVolumeDatas,s=i.tileDatas.verticesArr,u=i.tileDatas.indicesArr,d=i.tileDatas.matArr;i.tileDatas.stride;let c=new Float64Array(o),l=[];for(let r=0;r<s.length;r++){let i=5*r,a=new e.Cartesian3(c[i],c[i+1],c[i+2]),o=c[i+3],y=new t.BoundingSphere(a,o),h={};h.vertices=new Float32Array(s[l.length]),h.indices=new Uint16Array(u[l.length]);let p=new Float64Array(d[l.length]);const g=f.Matrix4.fromArray(p);let A=new n.TerrainEncoding(y.center,void 0,void 0,void 0,g,!0,!0,!1,1,0);A.quantization=1,A.stride=c[i+4],h.encoding=A;let x=new P;x.mesh=h,x.vertexArray=[],x.key=Math.random(),x.boundingSphere=y,l.push(x)}let y=new Float64Array(i.rayDatas),h=new e.Cartesian3(y[0],y[1],y[2]),p={},g=[];for(let t=3;t<y.length;t++){let n=new e.Cartesian3(y[t],y[t+1],y[t+2]),i=new r.Ray(h,n);X(i,l,p),g.push(i),t+=2}let A=[];for(let e in p)A.push(p[e]);var x;A.sort((x=h,function(e,r){return t.BoundingSphere.distanceSquaredTo(e.pickBoundingSphere,x)-t.BoundingSphere.distanceSquaredTo(r.pickBoundingSphere,x)}));let D=[];for(let e=0;e<g.length;e++){let t=$(g[e],A);if(t){let e=J(t);D.push(e.lng),D.push(e.lat),D.push(e.height)}else D.push(1e3),D.push(1e3),D.push(0)}let m=new Float64Array(D);return a.push(m.buffer),m.buffer}))}));
