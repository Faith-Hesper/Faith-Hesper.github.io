define(["exports","./Transforms-b1e48e05","./ComponentDatatype-63fd8cd4","./defaultValue-9f6a6288","./defined-64766648","./Ellipsoid-fa58f06f","./GeographicProjection-868b0b16","./Geometry-dd0ae099","./GeometryAttribute-5ac032ac","./GeometryAttributes-3de79df5","./GeometryPipeline-92c34dd1","./IndexDatatype-ed8b21cb","./Matrix2-e52b9454","./WebMercatorProjection-78306e76"],(function(e,t,n,o,r,i,s,c,a,d,p,u,f,l){"use strict";function m(e,t,n){e=o.defaultValue(e,0),t=o.defaultValue(t,0),n=o.defaultValue(n,0),this.value=new Float32Array([e,t,n])}function h(e,t){const o=e.attributes,r=o.position,i=r.values.length/r.componentsPerAttribute;o.batchId=new a.GeometryAttribute({componentDatatype:n.ComponentDatatype.FLOAT,componentsPerAttribute:1,values:new Float32Array(i)});const s=o.batchId.values;for(let e=0;e<i;++e)s[e]=t}function g(e){const o=e.instances,i=e.projection,s=e.elementIndexUintSupported,c=e.scene3DOnly,a=e.vertexCacheOptimize,d=e.compressVertices,u=e.modelMatrix;let l,m,g=o.length;for(l=0;l<g;++l)if(r.defined(o[l].geometry)){o[l].geometry.primitiveType;break}if(function(e,t,n){let o=!n;const i=e.length;let s;if(!o&&i>1){const t=e[0].modelMatrix;for(s=1;s<i;++s)if(!f.Matrix4.equals(t,e[s].modelMatrix)){o=!0;break}}if(o)for(s=0;s<i;++s)r.defined(e[s].geometry)&&p.GeometryPipeline.transformToWorldCoordinates(e[s]);else f.Matrix4.multiplyTransformation(t,e[0].modelMatrix,t)}(o,u,c),!c)for(l=0;l<g;++l)r.defined(o[l].geometry)&&p.GeometryPipeline.splitLongitude(o[l]);if(function(e){const t=e.length;for(let n=0;n<t;++n){const t=e[n];r.defined(t.geometry)?h(t.geometry,n):r.defined(t.westHemisphereGeometry)&&r.defined(t.eastHemisphereGeometry)&&(h(t.westHemisphereGeometry,n),h(t.eastHemisphereGeometry,n))}}(o),a)for(l=0;l<g;++l){const e=o[l];r.defined(e.geometry)?(p.GeometryPipeline.reorderForPostVertexCache(e.geometry),p.GeometryPipeline.reorderForPreVertexCache(e.geometry)):r.defined(e.westHemisphereGeometry)&&r.defined(e.eastHemisphereGeometry)&&(p.GeometryPipeline.reorderForPostVertexCache(e.westHemisphereGeometry),p.GeometryPipeline.reorderForPreVertexCache(e.westHemisphereGeometry),p.GeometryPipeline.reorderForPostVertexCache(e.eastHemisphereGeometry),p.GeometryPipeline.reorderForPreVertexCache(e.eastHemisphereGeometry))}let y=p.GeometryPipeline.combineInstances(o);for(g=y.length,l=0;l<g;++l){m=y[l];const e=m.attributes;if(c)for(const t in e)e.hasOwnProperty(t)&&e[t].componentDatatype===n.ComponentDatatype.DOUBLE&&p.GeometryPipeline.encodeAttribute(m,t,`${t}3DHigh`,`${t}3DLow`);else for(const o in e)if(e.hasOwnProperty(o)&&e[o].componentDatatype===n.ComponentDatatype.DOUBLE){const e=`${o}3D`,n=`${o}2D`;p.GeometryPipeline.projectTo2D(m,o,e,n,i),r.defined(m.boundingSphere)&&"position"===o&&(m.boundingSphereCV=t.BoundingSphere.fromVertices(m.attributes.position2D.values)),p.GeometryPipeline.encodeAttribute(m,e,`${e}High`,`${e}Low`),p.GeometryPipeline.encodeAttribute(m,n,`${n}High`,`${n}Low`)}d&&p.GeometryPipeline.compressVertices(m)}if(!s){let e=[];for(g=y.length,l=0;l<g;++l)m=y[l],e=e.concat(p.GeometryPipeline.fitToUnsignedShortIndices(m));y=e}return y}function y(e,t,n,o){let i,s,c;const a=o.length-1;if(a>=0){const e=o[a];i=e.offset+e.count,c=e.index,s=n[c].indices.length}else i=0,c=0,s=n[c].indices.length;const d=e.length;for(let a=0;a<d;++a){const d=e[a][t];if(!r.defined(d))continue;const p=d.indices.length;i+p>s&&(i=0,s=n[++c].indices.length),o.push({index:c,offset:i,count:p}),i+=p}}Object.defineProperties(m.prototype,{componentDatatype:{get:function(){return n.ComponentDatatype.FLOAT}},componentsPerAttribute:{get:function(){return 3}},normalize:{get:function(){return!1}}}),m.fromCartesian3=function(e){return new m(e.x,e.y,e.z)},m.toValue=function(e,t){return r.defined(t)||(t=new Float32Array([e.x,e.y,e.z])),t[0]=e.x,t[1]=e.y,t[2]=e.z,t};const b={};function G(e,t){const n=e.attributes;for(const e in n)if(n.hasOwnProperty(e)){const o=n[e];r.defined(o)&&r.defined(o.values)&&t.push(o.values.buffer)}r.defined(e.indices)&&t.push(e.indices.buffer)}function x(e,t){const n=e.length,o=new Float64Array(1+19*n);let i=0;o[i++]=n;for(let t=0;t<n;t++){const n=e[t];if(f.Matrix4.pack(n.modelMatrix,o,i),i+=f.Matrix4.packedLength,r.defined(n.attributes)&&r.defined(n.attributes.offset)){const e=n.attributes.offset.value;o[i]=e[0],o[i+1]=e[1],o[i+2]=e[2]}i+=3}return t.push(o.buffer),o}function S(e){const n=e.length,o=1+(t.BoundingSphere.packedLength+1)*n,i=new Float32Array(o);let s=0;i[s++]=n;for(let o=0;o<n;++o){const n=e[o];r.defined(n)?(i[s++]=1,t.BoundingSphere.pack(e[o],i,s)):i[s++]=0,s+=t.BoundingSphere.packedLength}return i}function P(e){const n=new Array(e[0]);let o=0,r=1;for(;r<e.length;)1===e[r++]&&(n[o]=t.BoundingSphere.unpack(e,r)),++o,r+=t.BoundingSphere.packedLength;return n}b.combineGeometry=function(e){let n,o;const i=e.instances,s=i.length;let c,a,d=!1;s>0&&(n=g(e),n.length>0&&(o=p.GeometryPipeline.createAttributeLocations(n[0]),e.createPickOffsets&&(c=function(e,t){const n=[];return y(e,"geometry",t,n),y(e,"westHemisphereGeometry",t,n),y(e,"eastHemisphereGeometry",t,n),n}(i,n))),r.defined(i[0].attributes)&&r.defined(i[0].attributes.offset)&&(a=new Array(s),d=!0));const u=new Array(s),f=new Array(s);for(let e=0;e<s;++e){const n=i[e],o=n.geometry;r.defined(o)&&(u[e]=o.boundingSphere,f[e]=o.boundingSphereCV,d&&(a[e]=n.geometry.offsetAttribute));const s=n.eastHemisphereGeometry,c=n.westHemisphereGeometry;r.defined(s)&&r.defined(c)&&(r.defined(s.boundingSphere)&&r.defined(c.boundingSphere)&&(u[e]=t.BoundingSphere.union(s.boundingSphere,c.boundingSphere)),r.defined(s.boundingSphereCV)&&r.defined(c.boundingSphereCV)&&(f[e]=t.BoundingSphere.union(s.boundingSphereCV,c.boundingSphereCV)))}return{geometries:n,modelMatrix:e.modelMatrix,attributeLocations:o,pickOffsets:c,offsetInstanceExtend:a,boundingSpheres:u,boundingSpheresCV:f}},b.packCreateGeometryResults=function(e,n){const i=new Float64Array(function(e){let n=1;const o=e.length;for(let i=0;i<o;i++){const o=e[i];if(++n,!r.defined(o))continue;const s=o.attributes;n+=7+2*t.BoundingSphere.packedLength+(r.defined(o.indices)?o.indices.length:0);for(const e in s)s.hasOwnProperty(e)&&r.defined(s[e])&&(n+=5+s[e].values.length)}return n}(e)),s=[],c={},a=e.length;let d=0;i[d++]=a;for(let n=0;n<a;n++){const a=e[n],p=r.defined(a);if(i[d++]=p?1:0,!p)continue;i[d++]=a.primitiveType,i[d++]=a.geometryType,i[d++]=o.defaultValue(a.offsetAttribute,-1);const u=r.defined(a.boundingSphere)?1:0;i[d++]=u,u&&t.BoundingSphere.pack(a.boundingSphere,i,d),d+=t.BoundingSphere.packedLength;const f=r.defined(a.boundingSphereCV)?1:0;i[d++]=f,f&&t.BoundingSphere.pack(a.boundingSphereCV,i,d),d+=t.BoundingSphere.packedLength;const l=a.attributes,m=[];for(const e in l)l.hasOwnProperty(e)&&r.defined(l[e])&&(m.push(e),r.defined(c[e])||(c[e]=s.length,s.push(e)));i[d++]=m.length;for(let e=0;e<m.length;e++){const t=m[e],n=l[t];i[d++]=c[t],i[d++]=n.componentDatatype,i[d++]=n.componentsPerAttribute,i[d++]=n.normalize?1:0,i[d++]=n.values.length,i.set(n.values,d),d+=n.values.length}const h=r.defined(a.indices)?a.indices.length:0;i[d++]=h,h>0&&(i.set(a.indices,d),d+=h)}return n.push(i.buffer),{stringTable:s,packedData:i}},b.unpackCreateGeometryResults=function(e){const o=e.stringTable,r=e.packedData;let i;const s=new Array(r[0]);let p=0,f=1;for(;f<r.length;){if(!(1===r[f++])){s[p++]=void 0;continue}const e=r[f++],l=r[f++];let m,h,g=r[f++];-1===g&&(g=void 0);1===r[f++]&&(m=t.BoundingSphere.unpack(r,f)),f+=t.BoundingSphere.packedLength;let y,b,G;1===r[f++]&&(h=t.BoundingSphere.unpack(r,f)),f+=t.BoundingSphere.packedLength;const x=new d.GeometryAttributes,S=r[f++];for(i=0;i<S;i++){const e=o[r[f++]],t=r[f++];G=r[f++];const i=0!==r[f++];y=r[f++],b=n.ComponentDatatype.createTypedArray(t,y);for(let e=0;e<y;e++)b[e]=r[f++];x[e]=new a.GeometryAttribute({componentDatatype:t,componentsPerAttribute:G,normalize:i,values:b})}let P;if(y=r[f++],y>0){const e=b.length/G;for(P=u.IndexDatatype.createTypedArray(e,y),i=0;i<y;i++)P[i]=r[f++]}s[p++]=new c.Geometry({primitiveType:e,geometryType:l,boundingSphere:m,boundingSphereCV:h,indices:P,attributes:x,offsetAttribute:g})}return s},b.packCombineGeometryParameters=function(e,t){const n=e.createGeometryResults,o=n.length;for(let e=0;e<o;e++)t.push(n[e].packedData.buffer);return{createGeometryResults:e.createGeometryResults,packedInstances:x(e.instances,t),ellipsoid:e.ellipsoid,isGeographic:e.projection instanceof s.GeographicProjection,elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:e.modelMatrix,createPickOffsets:e.createPickOffsets}},b.unpackCombineGeometryParameters=function(e){const t=function(e){const t=e,n=new Array(t[0]);let o=0,i=1;for(;i<t.length;){const e=f.Matrix4.unpack(t,i);let s;i+=f.Matrix4.packedLength,r.defined(t[i])&&(s={offset:new m(t[i],t[i+1],t[i+2])}),i+=3,n[o++]={modelMatrix:e,attributes:s}}return n}(e.packedInstances),n=e.createGeometryResults,o=n.length;let c=0;for(let e=0;e<o;e++){const o=b.unpackCreateGeometryResults(n[e]),r=o.length;for(let e=0;e<r;e++){const n=o[e];t[c].geometry=n,++c}}const a=i.Ellipsoid.clone(e.ellipsoid);return{instances:t,ellipsoid:a,projection:e.isGeographic?new s.GeographicProjection(a):new l.WebMercatorProjection(a),elementIndexUintSupported:e.elementIndexUintSupported,scene3DOnly:e.scene3DOnly,vertexCacheOptimize:e.vertexCacheOptimize,compressVertices:e.compressVertices,modelMatrix:f.Matrix4.clone(e.modelMatrix),createPickOffsets:e.createPickOffsets}},b.packCombineGeometryResults=function(e,t){r.defined(e.geometries)&&function(e,t){const n=e.length;for(let o=0;o<n;++o)G(e[o],t)}(e.geometries,t);const n=S(e.boundingSpheres),o=S(e.boundingSpheresCV);return t.push(n.buffer,o.buffer),{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:n,boundingSpheresCV:o}},b.unpackCombineGeometryResults=function(e){return{geometries:e.geometries,attributeLocations:e.attributeLocations,modelMatrix:e.modelMatrix,pickOffsets:e.pickOffsets,offsetInstanceExtend:e.offsetInstanceExtend,boundingSpheres:P(e.boundingSpheres),boundingSpheresCV:P(e.boundingSpheresCV)}};var k=b;e.PrimitivePipeline=k}));
