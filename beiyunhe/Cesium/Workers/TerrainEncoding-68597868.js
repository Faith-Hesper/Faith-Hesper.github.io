define(["exports","./AttributeCompression-44abee07","./Cartesian2-0a34ed75","./Cartesian3-e96ac170","./ComponentDatatype-63fd8cd4","./defaultValue-9f6a6288","./defined-64766648","./Math-56779564","./Matrix2-e52b9454"],(function(t,e,i,r,o,a,s,n,c){"use strict";const m={getHeight:function(t,e,i){return(t-i)*e+i}},h=new r.Cartesian3;m.getPosition=function(t,e,i,o,a){const s=e.cartesianToCartographic(t,h),n=m.getHeight(s.height,i,o);return r.Cartesian3.fromRadians(s.longitude,s.latitude,n,e,a)};var u=m;var d=Object.freeze({NONE:0,BITS12:1});const l=new r.Cartesian3,f=new r.Cartesian3,x=new i.Cartesian2,p=new c.Matrix4,g=new c.Matrix4,C=Math.pow(2,12);function N(t,e,i,o,n,m,h,u,x,N){let S,y,M=d.NONE;if(s.defined(e)&&s.defined(i)&&s.defined(o)&&s.defined(n)){const t=e.minimum,a=e.maximum,s=r.Cartesian3.subtract(a,t,f),m=o-i;M=Math.max(r.Cartesian3.maximumComponent(s),m)<C-1?d.BITS12:d.NONE,S=c.Matrix4.inverseTransformation(n,new c.Matrix4);const h=r.Cartesian3.negate(t,l);c.Matrix4.multiply(c.Matrix4.fromTranslation(h,p),S,S);const u=l;u.x=1/s.x,u.y=1/s.y,u.z=1/s.z,c.Matrix4.multiply(c.Matrix4.fromScale(u,p),S,S),y=c.Matrix4.clone(n),c.Matrix4.setTranslation(y,r.Cartesian3.ZERO,y),n=c.Matrix4.clone(n,new c.Matrix4);const x=c.Matrix4.fromTranslation(t,p),N=c.Matrix4.fromScale(s,g),T=c.Matrix4.multiply(x,N,p);c.Matrix4.multiply(n,T,n),c.Matrix4.multiply(y,T,y)}this.quantization=M,this.minimumHeight=i,this.maximumHeight=o,this.center=r.Cartesian3.clone(t),this.toScaledENU=S,this.fromScaledENU=n,this.matrix=y,this.hasVertexNormals=m,this.hasWebMercatorT=a.defaultValue(h,!1),this.hasGeodeticSurfaceNormals=a.defaultValue(u,!1),this.exaggeration=a.defaultValue(x,1),this.exaggerationRelativeHeight=a.defaultValue(N,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}N.prototype.encode=function(t,o,a,s,m,h,u,f){const p=s.x,g=s.y;if(this.quantization===d.BITS12){(a=c.Matrix4.multiplyByPoint(this.toScaledENU,a,l)).x=n.CesiumMath.clamp(a.x,0,1),a.y=n.CesiumMath.clamp(a.y,0,1),a.z=n.CesiumMath.clamp(a.z,0,1);const r=this.maximumHeight-this.minimumHeight,s=n.CesiumMath.clamp((m-this.minimumHeight)/r,0,1);i.Cartesian2.fromElements(a.x,a.y,x);const h=e.AttributeCompression.compressTextureCoordinates(x);i.Cartesian2.fromElements(a.z,s,x);const d=e.AttributeCompression.compressTextureCoordinates(x);i.Cartesian2.fromElements(p,g,x);const f=e.AttributeCompression.compressTextureCoordinates(x);if(t[o++]=h,t[o++]=d,t[o++]=f,this.hasWebMercatorT){i.Cartesian2.fromElements(u,0,x);const r=e.AttributeCompression.compressTextureCoordinates(x);t[o++]=r}}else r.Cartesian3.subtract(a,this.center,l),t[o++]=l.x,t[o++]=l.y,t[o++]=l.z,t[o++]=m,t[o++]=p,t[o++]=g,this.hasWebMercatorT&&(t[o++]=u);return this.hasVertexNormals&&(t[o++]=e.AttributeCompression.octPackFloat(h)),this.hasGeodeticSurfaceNormals&&(t[o++]=f.x,t[o++]=f.y,t[o++]=f.z),o};const S=new r.Cartesian3,y=new r.Cartesian3;N.prototype.addGeodeticSurfaceNormals=function(t,e,i){if(this.hasGeodeticSurfaceNormals)return;const r=this.stride,o=t.length/r;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();const a=this.stride;for(let s=0;s<o;s++){for(let i=0;i<r;i++){const o=s*r+i;e[s*a+i]=t[o]}const o=this.decodePosition(e,s,S),n=i.geodeticSurfaceNormal(o,y),c=s*a+this._offsetGeodeticSurfaceNormal;e[c]=n.x,e[c+1]=n.y,e[c+2]=n.z}},N.prototype.removeGeodeticSurfaceNormals=function(t,e){if(!this.hasGeodeticSurfaceNormals)return;const i=this.stride,r=t.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();const o=this.stride;for(let a=0;a<r;a++)for(let r=0;r<o;r++){const s=a*i+r;e[a*o+r]=t[s]}},N.prototype.decodePosition=function(t,i,o){if(s.defined(o)||(o=new r.Cartesian3),i*=this.stride,this.quantization===d.BITS12){const r=e.AttributeCompression.decompressTextureCoordinates(t[i],x);o.x=r.x,o.y=r.y;const a=e.AttributeCompression.decompressTextureCoordinates(t[i+1],x);return o.z=a.x,c.Matrix4.multiplyByPoint(this.fromScaledENU,o,o)}return o.x=t[i],o.y=t[i+1],o.z=t[i+2],r.Cartesian3.add(o,this.center,o)},N.prototype.getExaggeratedPosition=function(t,e,i){i=this.decodePosition(t,e,i);const r=this.exaggeration,o=this.exaggerationRelativeHeight;if(1!==r&&this.hasGeodeticSurfaceNormals){const a=this.decodeGeodeticSurfaceNormal(t,e,y),s=this.decodeHeight(t,e),n=u.getHeight(s,r,o)-s;i.x+=a.x*n,i.y+=a.y*n,i.z+=a.z*n}return i},N.prototype.decodeTextureCoordinates=function(t,r,o){return s.defined(o)||(o=new i.Cartesian2),r*=this.stride,this.quantization===d.BITS12?e.AttributeCompression.decompressTextureCoordinates(t[r+2],o):i.Cartesian2.fromElements(t[r+4],t[r+5],o)},N.prototype.decodeHeight=function(t,i){if(i*=this.stride,this.quantization===d.BITS12){return e.AttributeCompression.decompressTextureCoordinates(t[i+1],x).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight}return t[i+3]},N.prototype.decodeWebMercatorT=function(t,i){return i*=this.stride,this.quantization===d.BITS12?e.AttributeCompression.decompressTextureCoordinates(t[i+3],x).x:t[i+6]},N.prototype.getOctEncodedNormal=function(t,e,r){const o=t[e=e*this.stride+this._offsetVertexNormal]/256,a=Math.floor(o),s=256*(o-a);return i.Cartesian2.fromElements(a,s,r)},N.prototype.decodeGeodeticSurfaceNormal=function(t,e,i){return e=e*this.stride+this._offsetGeodeticSurfaceNormal,i.x=t[e],i.y=t[e+1],i.z=t[e+2],i},N.prototype._calculateStrideAndOffsets=function(){let t=0;if(this.quantization===d.BITS12)t+=3;else t+=6;this.hasWebMercatorT&&(t+=1),this.hasVertexNormals&&(this._offsetVertexNormal=t,t+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=t,t+=3),this.stride=t};const M={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},T={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};N.prototype.getAttributes=function(t){const e=o.ComponentDatatype.FLOAT,i=o.ComponentDatatype.getSizeInBytes(e),r=this.stride*i;let a=0;const s=[];function n(o,n){s.push({index:o,vertexBuffer:t,componentDatatype:e,componentsPerAttribute:n,offsetInBytes:a,strideInBytes:r}),a+=n*i}if(this.quantization===d.NONE){n(M.position3DAndHeight,4);let t=2;t+=this.hasWebMercatorT?1:0,t+=this.hasVertexNormals?1:0,n(M.textureCoordAndEncodedNormals,t),this.hasGeodeticSurfaceNormals&&n(M.geodeticSurfaceNormal,3)}else{const t=this.hasWebMercatorT||this.hasVertexNormals,e=this.hasWebMercatorT&&this.hasVertexNormals;n(T.compressed0,t?4:3),e&&n(T.compressed1,1),this.hasGeodeticSurfaceNormals&&n(T.geodeticSurfaceNormal,3)}return s},N.prototype.getAttributeLocations=function(){return this.quantization===d.NONE?M:T},N.clone=function(t,e){if(s.defined(t))return s.defined(e)||(e=new N),e.quantization=t.quantization,e.minimumHeight=t.minimumHeight,e.maximumHeight=t.maximumHeight,e.center=r.Cartesian3.clone(t.center),e.toScaledENU=c.Matrix4.clone(t.toScaledENU),e.fromScaledENU=c.Matrix4.clone(t.fromScaledENU),e.matrix=c.Matrix4.clone(t.matrix),e.hasVertexNormals=t.hasVertexNormals,e.hasWebMercatorT=t.hasWebMercatorT,e.hasGeodeticSurfaceNormals=t.hasGeodeticSurfaceNormals,e.exaggeration=t.exaggeration,e.exaggerationRelativeHeight=t.exaggerationRelativeHeight,e._calculateStrideAndOffsets(),e},t.TerrainEncoding=N}));
