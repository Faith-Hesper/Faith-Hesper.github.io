define(["./snappyJs","./CodeTool","./GisTools"],(function(e,t,r){"use strict";return class{constructor(e,t,r){this.headerLength=t,this.proSizeObj=r,this.intLength=4,this.vectorVarintBuffer=e,this.layerMap=new Object,this.vectorHeaderProMap=new Object,this.layerHeaderProMap=new Object,this.layerHeaderProBuffer=new Object,this.geometyTypeMap=new Object,this.featureMap=new Object,this.featureArrayMap=new Object,this.offsetBufferMap=new Object,this.offsetArrayMap=new Object,this.varintMap=new Object}getAllLayerNames(){let e=[];for(let t in this.layerMap)e.push(t);return e}getGeometryType(e){return this.geometyTypeMap[e]}async getLayerPro(e){return this._lazyParseFeature(e)}getOffsetByIndex(e,t){let r=this.offsetArrayMap[e],a=[];return a.push(r[2*t]),a.push(r[2*t+1]),a}getAllCoordinates(e,t){let r,a,s,i=this.offsetArrayMap[e],n=this.varintMap[e],h=[];for(let e=0;e<i.length/2;e++)r=i[2*e],a=i[2*e+1],s=n.slice(r,r+a),h.push(this._bufferToDoubleArray(s,t));return h}getCoordinatesByIndex(e,t,r){let a=this.getOffsetByIndex(e,t),s=this.varintMap[e],i=a[0],n=a[1],h=s.slice(i,i+n);return this._bufferToDoubleArray(h,r)}async _parseVector(e){let t=this.headerLength,r=e.readInt32BE(t);t+=this.intLength;let a=e.slice(t,t+r).toString("utf-8");if(t+=r,"vector"!==a)return void console.error("不是瓦片数据！");let s=this._parseHeaderPro(e,t,"none");t=s[0];let i=s[1].zipType;this.vectorHeaderProMap=s[1];let n=e.readInt32BE(t);t+=this.intLength;let h=e.slice(t,t+n);t+=n;let l,f,o,p=e.slice(t,this.vectorVarintBuffer.length),u=0,y=0,c=0,g=0;for(let e=0;e<h.length;)c=e,u=h.readInt32BE(c),c+=this.intLength,g=c+u,l=h.toString("utf8",c,g),c=g,f=h.readInt32BE(c),c+=this.intLength,o=p.slice(y,y+f),y+=f,this.layerMap[l]=o,this._parseLayer(l,o,i),e=c}_parseLayer(t,r,a){if(0===r.length)return;let s=this.headerLength,i=this._parseHeaderPro(r,s,a);s=i[0],this.layerHeaderProMap[t]=i[1],this.layerHeaderProBuffer[t]=i[2];let n=this.layerHeaderProMap[t].gType;this.geometyTypeMap[t]=n;let h=r.readInt32BE(s);s+=this.intLength;let l=r.slice(s,s+h);l=e(l),s+=h,this.featureMap[t]=l;let f=this._parseIndex(r,s);s=f.offset,this.offsetBufferMap[t]=f.buffer,this.offsetArrayMap[t]=f.array;let o=r.slice(s);this.varintMap[t]=o}_parseHeaderPro(t,a,s){let i=new Object,n=t.readInt32BE(a);a+=this.intLength;let h=t.slice(a,a+n);if(a+=n,0==n)return[a,i];h=e(h);let l=r.Utf8ArrayToStr(h).split(":");for(let e=0;e<l.length/2;e++)i[l[2*e]]=l[2*e+1];return[a,i,h]}_parseIndex(e,r){let a=e.readInt32BE(r);r+=this.intLength;let s=e.slice(r,r+a);return{offset:r+=a,buffer:s,array:t.varintToIntArray(s)}}_lazyParseFeature(e){let t=this.featureArrayMap[e],a=this.proSizeObj[e];if(null==t){let s=this.featureMap[e],i=[];if(!(s.length>0))return this.featureArrayMap[e]=[],[];i=r.Utf8ArrayToStr(s).split("#@");let n=[],h=(i.length-1)/a;t=[];let l=0,f=l;for(let e=0;e<h;e++)f=l+a,n=i.slice(l,f),t.push(n),l=f;this.featureArrayMap[e]=t}return t}_bufferToDoubleArray(e,r){let a,s,i,n=[],h=[],l=0,f=[],o=0,p=0,u=!0;for(let y=0;y<=e.length;y++)a=0|e[y]>>7&1,0===a&&l>0&&(l>0&&l<=5?(u?(s=t.varintToInt(n)+o,h.push(s/r),u=!1,o=s):(i=t.varintToInt(n)+p,h.push(i/r),u=!0,p=i),l=0,n=[]):l>5&&(o=0,p=0,l=0,n=[],f.push(h),h=[])),y!==e.length?(n.push(e[y]),l++):h.length>0&&f.push(h);return f}isEmpty(e){return null==this.offsetArrayMap[e]||0===this.offsetArrayMap[e].length}}}));
