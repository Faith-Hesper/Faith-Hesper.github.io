define(["./createTaskProcessorWorker-03824364","./Resource-be841477","./Cartesian3-e96ac170","./HouseDrawer","./snappyJs","./GetPrimitiveData","./ScanLine","./ElevationTool","./Cache","./defer-7878b392","./defaultValue-9f6a6288","./defined-64766648","./Math-56779564","./combine-ac72e009","./RuntimeError-cfbf2bc8","./Color-cad7c885","./Transforms-b1e48e05","./Ellipsoid-fa58f06f","./GeographicProjection-868b0b16","./Matrix3-59918a96","./Matrix2-e52b9454","./Cartesian2-0a34ed75","./ComponentDatatype-63fd8cd4","./WebGLConstants-7f557f93","./GeometryInstance-a555221e","./PolygonGeometry-9ef51ca3","./ArcType-26a3f38d","./BoundingRectangle-3100662d","./EllipsoidGeodesic-9e013872","./EllipsoidTangentPlane-8f36a7e0","./AxisAlignedBoundingBox-8b4e9f9c","./IntersectionTests-39c3b1c1","./Plane-f9bf6226","./Geometry-dd0ae099","./GeometryAttribute-5ac032ac","./GeometryOffsetAttribute-2579b8d2","./GeometryPipeline-92c34dd1","./AttributeCompression-44abee07","./EncodedCartesian3-e0f0a7d1","./IndexDatatype-ed8b21cb","./PolygonGeometryLibrary-37fe200f","./arrayRemoveDuplicates-d0608faf","./EllipsoidRhumbLine-cea00df6","./GeometryAttributes-3de79df5","./PolygonPipeline-d79010c3","./VertexFormat-01d05a0d","./PolygonOutlineGeometry-9f19e302","./Texture-3b0b528f","./PixelFormat-5109196d","./PrimitivePipeline-7bd2b931","./WebMercatorProjection-78306e76","./GetRidingLanternGeometry","./LinkedQueue"],(function(e,t,r,n,l,o,i,a,s,u,f,h,y,c,g,p,d,m,P,v,x,G,A,b,C,w,D,E,M,S,T,L,B,F,I,R,k,N,j,H,O,V,W,q,J,z,_,U,Q,$,K,X,Y){"use strict";let Z,ee,te,re=512,ne="",le={},oe={},ie=new s(1e5);function ae(e){let t=1e3,r=0;for(let n=0;n<e.length;n++){let l=e[n];for(let e=0;e<l.length-1;e++){let n=Math.round(l[e+1]);n<t&&(t=n),n>r&&(r=n),e++}}return{ymax:r,ymin:t}}function se(e,t){let n=t.rectangle;for(var l=[],o=0;o<e.length;o++){var i=ue(e[o],e[o+1],n),a=r.Cartesian3.fromDegrees(i[0],i[1]);l.push(a),o++}return l}function ue(e,t,r){var n=fe(r.west+r.width/re*e),l=fe(r.north-r.height/re*t);return[n=Number(n.toFixed(6)),l=Number(l.toFixed(6))]}function fe(e){return 180*e/Math.PI}function he(e,t){if(Array.isArray(t[0])){let r=t.length;for(let n=0;n<r;n++){he(e,t[n])}}else e.push(t)}function ye(e,t){if("F"!=e[0])if(Array.isArray(e[0])){let r=e.length;for(let n=0;n<r;n++){ye(e[n],t)}}else t&&function(e){let t=[e[0],e[1]];for(let r=2;r<e.length;r++){let n=t[0]+e[r],l=t[1]+e[r+1];e[r]=n,e[r+1]=l,t=[n,l],r++}}(e);else e[0]=[.05*-re,.05*-re,1.05*re,.05*-re,1.05*re,1.05*re,.05*-re,1.05*re]}return e.createTaskProcessorWorker((function(e,r){if(1==e.init)return void function(e){Z=new Function("drawer","level",e.styleStr),re=e.tileSize,ne=e.return_type,le=e,ee=e.indexDbNames,te=e.indexDbName,a.getDBMap(ee,oe)}(e);var s,f=e.url,h=new t.Resource({url:f});if(h.request.throttle=!1,h.request.throttleByServer=!0,h.request.type=1,!(s="stream_snappy"==ne?h.fetchArrayBuffer():h.fetchJson()))return!0;let y=[];y.push(s);let c=ee.slice(0,ee.length-1);y.push(a.getElevation(oe,c,e.xyz));let g=u.defer();return Promise.all(y).then((function(t){let s=t[0];if(s||(s={}),"stream_snappy"==ne){s=l(s);let e=function(e){let t=[],r=0,n=0;for(;r<e.length;){let l=e[r++];if(l<128)t[n++]=l;else if(l>191&&l<224){let o=e[r++];t[n++]=(31&l)<<6|63&o}else if(l>239&&l<365){let o=((7&l)<<18|(63&e[r++])<<12|(63&e[r++])<<6|63&e[r++])-65536;t[n++]=55296+(o>>10),t[n++]=56320+(1023&o)}else{let o=e[r++],i=e[r++];t[n++]=(15&l)<<12|(63&o)<<6|63&i}}let l=[],o=0,i=0,a=0,s=5e4,u=t.length/s-1;for(o=0;o<u;o++)i=o*s,a=(o+1)*s,l.push(String.fromCharCode.apply({},t.slice(i,a)));return i=o*s,a=t.length,l.push(String.fromCharCode.apply({},t.slice(i,a))),l=l.join(""),l}(new Uint8Array(s));s=JSON.parse(e)}let u=function(e,t){if(e&&e.layer){(function(e,t){for(let r in e){let n=e[r].features;n||(n=e[r].datas);for(let e=0;e<n.length;e++)ye(n[e][2],t)}})(e=e.layer,t.needDecode);let r={},l=new n([e],t.level,r,t.controlVector,t.highLightVector,t.filterLayerId);return Z.call({},l,t.level),function(e){for(let t in e){let r=e[t];for(let e=0;e<r.length;e++){let t=r[e],n=[];he(n,t.data),delete t.data,t.geometrys=n;let l=0;if(le.hasOwnProperty("heightProperty")){let e=le.heightProperty;l=t.properties[e],le.hasOwnProperty("heightScale")&&(l*=parseFloat(le.heightScale))}t.height=l,t.totalHeight=l}}}(r),r}return{}}(s,e);le.hasTerrain&&function(e,t){var r=1e3,n=0;for(let l in e){let o=e[l];for(let e=0;e<o.length;e++){let l=o[e],i=-2e4,a=ie.get(l.properties.id);if(a)i=a;else{for(let e=0;e<l.geometrys.length;e++){let o=l.geometrys[e];for(let e=0;e<o.length-1;e++){let l=Math.round(o[e]),a=Math.round(o[e+1]);if(a<r&&(r=a),a>n&&(n=a),e++,l<0||l>re-1||a<0||a>re-1)continue;let s=a*re+l,u=0;for(let e in t){u+=t[e].data[s]}u>i&&(i=u)}}-2e4==i&&(i=0),ie.set(l.properties.id,i)}l.terrainHeight=i,l.totalHeight=i+l.height}}}(u,t[1]);let f=function(e,t){let r=new Int32Array(t*t);for(let n in e){let l=e[n];for(let e=0;e<l.length;e++){let n=l[e],o=ae(n.geometrys);i(r,n,t,o.ymax,o.ymin)}}return r}(u,re);!function(e,t){for(let r in e){let n=e[r];for(let e=0;e<n.length;e++){let r=n[e];r.polygons=[];for(let e=0;e<r.geometrys.length;e++){let n=se(r.geometrys[e],t);r.polygons.push(n)}delete r.geometrys}}}(u,e);let h=o(u,e.level,le,r);a.updateElevation(oe[te],te,e.xyz,f).finally((function(e){g.resolve(h)}))}),(function(e){g.reject(e)})),g.promise}))}));
