define(["./AxisAlignedBoundingBox-8b4e9f9c","./Transforms-b1e48e05","./Cartesian2-0a34ed75","./Cartesian3-e96ac170","./Ellipsoid-fa58f06f","./defaultValue-9f6a6288","./defined-64766648","./EllipsoidalOccluder-23ed042c","./Math-56779564","./Matrix2-e52b9454","./OrientedBoundingBox-fa9d7c73","./RuntimeError-cfbf2bc8","./TerrainEncoding-68597868","./WebMercatorProjection-78306e76","./createTaskProcessorWorker-03824364","./GeographicProjection-868b0b16","./Matrix3-59918a96","./Resource-be841477","./combine-ac72e009","./defer-7878b392","./EllipsoidTangentPlane-8f36a7e0","./IntersectionTests-39c3b1c1","./Plane-f9bf6226","./AttributeCompression-44abee07","./ComponentDatatype-63fd8cd4","./WebGLConstants-7f557f93"],(function(t,e,n,i,o,r,a,s,c,u,h,l,d,g,m,p,E,I,T,f,C,M,x,N,S,b){"use strict";const P=Uint16Array.BYTES_PER_ELEMENT,w=Int32Array.BYTES_PER_ELEMENT,B=Uint32Array.BYTES_PER_ELEMENT,A=Float32Array.BYTES_PER_ELEMENT,R=Float64Array.BYTES_PER_ELEMENT;function y(t,e,n){n=r.defaultValue(n,c.CesiumMath);const i=t.length;for(let o=0;o<i;++o)if(n.equalsEpsilon(t[o],e,c.CesiumMath.EPSILON12))return o;return-1}const W=new o.Cartographic,_=new i.Cartesian3,F=new i.Cartesian3,v=new i.Cartesian3,O=new u.Matrix4;function Y(t,e,r,s,h,l,d,g,m,p,E){const I=g.length;for(let T=0;T<I;++T){const f=g[T],C=f.cartographic,M=f.index,x=t.length,N=C.longitude;let S=C.latitude;S=c.CesiumMath.clamp(S,-c.CesiumMath.PI_OVER_TWO,c.CesiumMath.PI_OVER_TWO);const b=C.height-d.skirtHeight;d.hMin=Math.min(d.hMin,b),o.Cartographic.fromRadians(N,S,b,W),p&&(W.longitude+=m),p?T===I-1?W.latitude+=E:0===T&&(W.latitude-=E):W.latitude+=m;const P=d.ellipsoid.cartographicToCartesian(W);t.push(P),e.push(b),r.push(n.Cartesian2.clone(r[M])),s.length>0&&s.push(s[M]),h.length>0&&h.push(h[M]),u.Matrix4.multiplyByPoint(d.toENU,P,_);const w=d.minimum,B=d.maximum;i.Cartesian3.minimumByComponent(_,w,w),i.Cartesian3.maximumByComponent(_,B,B);const A=d.lastBorderPoint;if(a.defined(A)){const t=A.index;l.push(t,x-1,x,x,M,t)}d.lastBorderPoint=f}}return m.createTaskProcessorWorker((function(r,m){r.ellipsoid=o.Ellipsoid.clone(r.ellipsoid),r.rectangle=n.Rectangle.clone(r.rectangle);const p=function(r,m,p,E,I,T,f,C,M,x,N){let S,b,k,V,H,U;a.defined(E)?(S=E.west,b=E.south,k=E.east,V=E.north,H=E.width,U=E.height):(S=c.CesiumMath.toRadians(I.west),b=c.CesiumMath.toRadians(I.south),k=c.CesiumMath.toRadians(I.east),V=c.CesiumMath.toRadians(I.north),H=c.CesiumMath.toRadians(E.width),U=c.CesiumMath.toRadians(E.height));const L=[b,V],G=[S,k],j=e.Transforms.eastNorthUpToFixedFrame(m,p),D=u.Matrix4.inverseTransformation(j,O);let z,q;M&&(z=g.WebMercatorProjection.geodeticLatitudeToMercatorAngle(b),q=1/(g.WebMercatorProjection.geodeticLatitudeToMercatorAngle(V)-z));const Z=1!==T,J=new DataView(r);let K=Number.POSITIVE_INFINITY,Q=Number.NEGATIVE_INFINITY;const X=F;X.x=Number.POSITIVE_INFINITY,X.y=Number.POSITIVE_INFINITY,X.z=Number.POSITIVE_INFINITY;const $=v;$.x=Number.NEGATIVE_INFINITY,$.y=Number.NEGATIVE_INFINITY,$.z=Number.NEGATIVE_INFINITY;let tt,et,nt=0,it=0,ot=0;for(et=0;et<4;++et){let t=nt;tt=J.getUint32(t,!0),t+=B;const e=c.CesiumMath.toRadians(180*J.getFloat64(t,!0));t+=R,-1===y(G,e)&&G.push(e);const n=c.CesiumMath.toRadians(180*J.getFloat64(t,!0));t+=R,-1===y(L,n)&&L.push(n),t+=2*R;let i=J.getInt32(t,!0);t+=w,it+=i,i=J.getInt32(t,!0),ot+=3*i,nt+=tt+B}const rt=[],at=[],st=new Array(it),ct=new Array(it),ut=new Array(it),ht=M?new Array(it):[],lt=Z?new Array(it):[],dt=new Array(ot),gt=[],mt=[],pt=[],Et=[];let It=0,Tt=0;for(nt=0,et=0;et<4;++et){tt=J.getUint32(nt,!0),nt+=B;const t=nt,e=c.CesiumMath.toRadians(180*J.getFloat64(nt,!0));nt+=R;const r=c.CesiumMath.toRadians(180*J.getFloat64(nt,!0));nt+=R;const a=c.CesiumMath.toRadians(180*J.getFloat64(nt,!0)),s=.5*a;nt+=R;const h=c.CesiumMath.toRadians(180*J.getFloat64(nt,!0)),d=.5*h;nt+=R;const m=J.getInt32(nt,!0);nt+=w;const E=J.getInt32(nt,!0);nt+=w,nt+=w;const I=new Array(m);for(let t=0;t<m;++t){const l=e+J.getUint8(nt++)*a;W.longitude=l;const m=r+J.getUint8(nt++)*h;W.latitude=m;let E=J.getFloat32(nt,!0);if(nt+=A,0!==E&&E<N&&(E*=-Math.pow(2,x)),E*=6371010,W.height=E,-1!==y(G,l)||-1!==y(L,m)){const e=y(rt,W,o.Cartographic);if(-1!==e){I[t]=at[e];continue}rt.push(o.Cartographic.clone(W)),at.push(It)}I[t]=It,Math.abs(l-S)<s?gt.push({index:It,cartographic:o.Cartographic.clone(W)}):Math.abs(l-k)<s?pt.push({index:It,cartographic:o.Cartographic.clone(W)}):Math.abs(m-b)<d?mt.push({index:It,cartographic:o.Cartographic.clone(W)}):Math.abs(m-V)<d&&Et.push({index:It,cartographic:o.Cartographic.clone(W)}),K=Math.min(E,K),Q=Math.max(E,Q),ut[It]=E;const T=p.cartographicToCartesian(W);if(st[It]=T,M&&(ht[It]=(g.WebMercatorProjection.geodeticLatitudeToMercatorAngle(m)-z)*q),Z){const t=p.geodeticSurfaceNormal(T);lt[It]=t}u.Matrix4.multiplyByPoint(D,T,_),i.Cartesian3.minimumByComponent(_,X,X),i.Cartesian3.maximumByComponent(_,$,$);let f=(l-S)/(k-S);f=c.CesiumMath.clamp(f,0,1);let C=(m-b)/(V-b);C=c.CesiumMath.clamp(C,0,1),ct[It]=new n.Cartesian2(f,C),++It}const T=3*E;for(let t=0;t<T;++t,++Tt)dt[Tt]=I[J.getUint16(nt,!0)],nt+=P;if(tt!==nt-t)throw new l.RuntimeError("Invalid terrain tile.")}st.length=It,ct.length=It,ut.length=It,M&&(ht.length=It);Z&&(lt.length=It);const ft=It,Ct=Tt,Mt={hMin:K,lastBorderPoint:void 0,skirtHeight:C,toENU:D,ellipsoid:p,minimum:X,maximum:$};gt.sort((function(t,e){return e.cartographic.latitude-t.cartographic.latitude})),mt.sort((function(t,e){return t.cartographic.longitude-e.cartographic.longitude})),pt.sort((function(t,e){return t.cartographic.latitude-e.cartographic.latitude})),Et.sort((function(t,e){return e.cartographic.longitude-t.cartographic.longitude}));const xt=1e-5;if(Y(st,ut,ct,ht,lt,dt,Mt,gt,-xt*H,!0,-xt*U),Y(st,ut,ct,ht,lt,dt,Mt,mt,-xt*U,!1),Y(st,ut,ct,ht,lt,dt,Mt,pt,xt*H,!0,xt*U),Y(st,ut,ct,ht,lt,dt,Mt,Et,xt*U,!1),gt.length>0&&Et.length>0){const t=gt[0].index,e=ft,n=Et[Et.length-1].index,i=st.length-1;dt.push(n,i,e,e,t,n)}it=st.length;const Nt=e.BoundingSphere.fromPoints(st);let St;a.defined(E)&&(St=h.OrientedBoundingBox.fromRectangle(E,K,Q,p));const bt=new s.EllipsoidalOccluder(p).computeHorizonCullingPointPossiblyUnderEllipsoid(m,st,K),Pt=new t.AxisAlignedBoundingBox(X,$,m),wt=new d.TerrainEncoding(m,Pt,Mt.hMin,Q,j,!1,M,Z,T,f),Bt=new Float32Array(it*wt.stride);let At=0;for(let t=0;t<it;++t)At=wt.encode(Bt,At,st[t],ct[t],ut[t],void 0,ht[t],lt[t]);const Rt=gt.map((function(t){return t.index})).reverse(),yt=mt.map((function(t){return t.index})).reverse(),Wt=pt.map((function(t){return t.index})).reverse(),_t=Et.map((function(t){return t.index})).reverse();return yt.unshift(Wt[Wt.length-1]),yt.push(Rt[0]),_t.unshift(Rt[Rt.length-1]),_t.push(Wt[0]),{vertices:Bt,indices:new Uint16Array(dt),maximumHeight:Q,minimumHeight:K,encoding:wt,boundingSphere3D:Nt,orientedBoundingBox:St,occludeePointInScaledSpace:bt,vertexCountWithoutSkirts:ft,indexCountWithoutSkirts:Ct,westIndicesSouthToNorth:Rt,southIndicesEastToWest:yt,eastIndicesNorthToSouth:Wt,northIndicesWestToEast:_t}}(r.buffer,r.relativeToCenter,r.ellipsoid,r.rectangle,r.nativeRectangle,r.exaggeration,r.exaggerationRelativeHeight,r.skirtHeight,r.includeWebMercatorT,r.negativeAltitudeExponentBias,r.negativeElevationThreshold),E=p.vertices;m.push(E.buffer);const I=p.indices;return m.push(I.buffer),{vertices:E.buffer,indices:I.buffer,numberOfAttributes:p.encoding.stride,minimumHeight:p.minimumHeight,maximumHeight:p.maximumHeight,boundingSphere3D:p.boundingSphere3D,orientedBoundingBox:p.orientedBoundingBox,occludeePointInScaledSpace:p.occludeePointInScaledSpace,encoding:p.encoding,vertexCountWithoutSkirts:p.vertexCountWithoutSkirts,indexCountWithoutSkirts:p.indexCountWithoutSkirts,westIndicesSouthToNorth:p.westIndicesSouthToNorth,southIndicesEastToWest:p.southIndicesEastToWest,eastIndicesNorthToSouth:p.eastIndicesNorthToSouth,northIndicesWestToEast:p.northIndicesWestToEast}}))}));
