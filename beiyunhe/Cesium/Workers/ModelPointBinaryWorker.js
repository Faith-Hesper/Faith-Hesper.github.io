define(["./createTaskProcessorWorker-03824364","./Resource-be841477","./Cartesian3-e96ac170","./ModelPointDrawer","./ParseBinaryData","./ScanLine","./ElevationTool","./Cache","./defer-7878b392","./defaultValue-9f6a6288","./defined-64766648","./Math-56779564","./combine-ac72e009","./RuntimeError-cfbf2bc8","./Buffer","./base64","./ieee754","./isArray","./VarintReader","./snappyJs","./CodeTool","./GisTools","./VarintReaderV3","./ZstdLoader","./zstd_wasm","./LinkedQueue"],(function(e,t,r,n,l,o,i,a,f,s,u,h,c,g,d,y,p,m,v,w,P,x,M,A,D,b){"use strict";let F,S,T,V={},k=512,B={},L={},R={},z=new a(1e5);function C(e,t){if("F"!=e[0])if(Array.isArray(e[0])){let r=e.length;for(let n=0;n<r;n++){C(e[n],t)}}else t&&function(e){let t=[e[0],e[1]];for(let r=2;r<e.length;r++){let n=t[0]+e[r],l=t[1]+e[r+1];e[r]=n,e[r+1]=l,t=[n,l],r++}}(e);else e[0]=[.05*-k,.05*-k,1.05*k,.05*-k,1.05*k,1.05*k,.05*-k,1.05*k]}function E(e){let t=1e3,r=0;for(let n=0;n<e.length;n++){let l=e[n];for(let e=0;e<l.length-1;e++){let n=Math.round(l[e+1]);n<t&&(t=n),n>r&&(r=n),e++}}return{ymax:r,ymin:t}}function I(e,t){if(Array.isArray(t[0])){let r=t.length;for(let n=0;n<r;n++){I(e,t[n])}}else e.push(t)}function N(e,t){let n=t.rectangle;for(var l=[],o=0;o<e.length;o++){var i=q(e[o],e[o+1],n),a=r.Cartesian3.fromDegrees(i[0],i[1]);l.push(a),o++}return l}function q(e,t,r){var n=H(r.west+r.width/k*e),l=H(r.north-r.height/k*t);return[n=Number(n.toFixed(6)),l=Number(l.toFixed(6))]}function H(e){return 180*e/Math.PI}return e.createTaskProcessorWorker((function(e,r){if(1==e.init)return void function(e){T=new Function("render","level",e.styleStr),k=e.tileSize,e.return_type,B=e,F=e.indexDbNames,S=e.indexDbName,L=e.serverInfo,R=e.layerFieldMap,i.getDBMap(F,V)}(e);var a=e.url,s=new t.Resource({url:a});s.request.throttle=!1,s.request.throttleByServer=!0,s.request.type=1;var u=s.fetchArrayBuffer();if(!u)return!0;let h=[];h.push(u);let c=F.slice(0,F.length-1);h.push(i.getElevation(V,c,e.xyz));let g=f.defer();return Promise.all(h).then((function(t){let r=t[0];if(!r)return void g.resolve({});let a=function(e,t){if(e){!function(e,t){for(let r in e){let n=e[r].features;n||(n=e[r].datas);for(let e=0;e<n.length;e++)C(n[e][2],t)}}(e,t.needDecode);let r={},l=new n([e],t.level,r,t.controlVector,t.highLightVector,t.filterLayerId);return T.call({},l,t.level),function(e){for(let t in e){let r=e[t];for(let e=0;e<r.length;e++){let t=r[e],n=[];I(n,t.data),delete t.data,t.geometrys=n;let l=0;if(B.hasOwnProperty("heightProperty")){let e=B.heightProperty;l=t.properties[e],B.hasOwnProperty("heightScale")&&(l*=parseFloat(B.heightScale))}t.height=l,t.totalHeight=l}}}(r),r}return{}}(l(r,R,L),e);B.hasTerrain&&function(e,t){var r=1e3,n=0;for(let l in e){let o=e[l];for(let e=0;e<o.length;e++){let l=o[e],i=-2e4,a=z.get(l.properties.id);if(a)i=a;else{for(let e=0;e<l.geometrys.length;e++){let o=l.geometrys[e];for(let e=0;e<o.length-1;e++){let l=Math.round(o[e]),a=Math.round(o[e+1]);if(a<r&&(r=a),a>n&&(n=a),e++,l<0||l>k-1||a<0||a>k-1)continue;let f=a*k+l,s=0;for(let e in t){s+=t[e].data[f]}s>i&&(i=s)}}-2e4==i&&(i=0),z.set(l.properties.id,i)}l.terrainHeight=i,l.totalHeight=i+l.height}}}(a,t[1]);let f=function(e,t){let r=new Int32Array(t*t);for(let n in e){let l=e[n];for(let e=0;e<l.length;e++){let n=l[e],i=E(n.geometrys);o(r,n,t,i.ymax,i.ymin)}}return r}(a,k);!function(e,t){for(let r in e){let n=e[r];for(let e=0;e<n.length;e++){let r=n[e];r.points=[];for(let e=0;e<r.geometrys.length;e++){let n=N(r.geometrys[e],t);r.points.push(n)}delete r.geometrys}}}(a,e),i.updateElevation(V[S],S,e.xyz,f).finally((function(e){g.resolve(a)}))}),(function(e){g.reject(e)})),g.promise}))}));
