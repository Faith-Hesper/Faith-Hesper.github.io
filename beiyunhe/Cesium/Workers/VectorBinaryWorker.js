define(["./createTaskProcessorWorker-03824364","./Resource-be841477","./VectorDrawer","./point-385fc661","./ColorUtil","./ParseBinaryData","./defaultValue-9f6a6288","./defined-64766648","./Math-56779564","./combine-ac72e009","./defer-7878b392","./RuntimeError-cfbf2bc8","./Buffer","./base64","./ieee754","./isArray","./VarintReader","./snappyJs","./CodeTool","./GisTools","./VarintReaderV3","./ZstdLoader","./zstd_wasm"],(function(e,t,r,l,i,n,a,o,s,f,u,c,d,y,h,g,p,k,w,F,b,z,C){"use strict";let v,B=512,S={},V={};function m(e,t){if(!e)return{};!function(e,t){for(let r in e){let l=e[r].features;l||(l=e[r].datas);for(let e=0;e<l.length;e++)A(l[e][2],t)}}(e=e.layer?e.layer:e,t.needDecode);let l={},i=new r([e],t.level,l,t.controlVector,t.highLightVector,t.filterLayerId);return v.call({},i,t.level),l}function A(e,t){if("F"!=e[0])if(Array.isArray(e[0])){let r=e.length;for(let l=0;l<r;l++){A(e[l],t)}}else t&&function(e){let t=[e[0],e[1]];for(let r=2;r<e.length;r++){let l=t[0]+e[r],i=t[1]+e[r+1];e[r]=l,e[r+1]=i,t=[l,i],r++}}(e);else e[0]=[.05*-B,.05*-B,1.05*B,.05*-B,1.05*B,1.05*B,.05*-B,1.05*B]}function D(e,t,r){let i=[];for(let r=0;r<e.keyArr.length;r++){let n=e[e.keyArr[r]],a=n.style;if(P(a),n.lineFeatues.length>0){let e=new l.LineBucket({style:a,type:"line",tileSize:B});for(let t of n.lineFeatues){L(t,a);let r=R(t);e.addFeature(r)}e=e.serialize(t),i.push(e)}else if(n.fillFeatures.length>0){let e=new l.FillBucket({style:a,type:"fill",tileSize:B}),r=new l.LineBucket({style:a,type:"line",tileSize:B});for(let t of n.fillFeatures){L(t,a);let l=R(t);e.addFeature(l),a.stroke&&r.addFeature(l)}e=e.serialize(t),i.push(e),a.stroke&&(r=r.serialize(t),i.push(r))}}return i}function L(e,t,r){if(!t.sparsity)return;let i=parseFloat(t.sparsity);for(let t=0;t<e.data.length;t++){let r=e.data[t];null==i&&1==i||(e.data[t]=l.simplify(r,i/4,!0))}}function R(e){let t=256/B*32,r=[];for(let i=0;i<e.data.length;i++){r[i]=[];let n=e.data[i];for(let e=0;e<n.length;e++)if(e%2==0){let a=n[e]*t,o=n[e+1]*t;r[i].push(new l.Point(a,o))}}return r}function P(e){let t=new i;if(e.fillColor){t.fromHex(e.fillColor);let r=[t.rgb[0]/255,t.rgb[1]/255,t.rgb[2]/255,1];e.fillColor=r}if(e.strokeColor){t=new i,t.fromHex(e.strokeColor);let r=[t.rgb[0]/255,t.rgb[1]/255,t.rgb[2]/255,1];e.strokeColor=r}}return e.createTaskProcessorWorker((async function(e,r){if(1==e.init)return v=new Function("render","level",e.styleStr),B=e.tileSize,e.return_type,S=e.serverInfo,V=e.layerFieldMap,!0;if(1==e.changeStyle){return D(m(await n(e.tileData,V,S),e),r)}var l=e.url,i=new t.Resource({url:l});i.request.throttle=!1,i.request.throttleByServer=!0,i.request.type=1;var a=i.fetchArrayBuffer();return!a||a.then((async function(t){return{tileData:t,buckets:D(m(await n(t,V,S),e),r)}}))}))}));
