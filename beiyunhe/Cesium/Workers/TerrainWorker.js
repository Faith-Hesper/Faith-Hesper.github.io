define(["./Resource-be841477","./GeographicTilingScheme-49f4aa7a","./Cartesian2-0a34ed75","./defaultValue-9f6a6288","./defined-64766648","./Ellipsoid-fa58f06f","./WebMercatorProjection-78306e76","./UPNG","./ElevationTool","./TerrainUpsample","./Cache","./defer-7878b392","./createTaskProcessorWorker-03824364","./Math-56779564","./combine-ac72e009","./RuntimeError-cfbf2bc8","./GeographicProjection-868b0b16","./Cartesian3-e96ac170","./LinkedQueue"],(function(e,t,r,n,i,o,s,l,a,u,c,h,f,g,p,d,y,_,x){"use strict";function w(e){if(e=n.defaultValue(e,n.defaultValue.EMPTY_OBJECT),this._ellipsoid=n.defaultValue(e.ellipsoid,o.Ellipsoid.WGS84),this._numberOfLevelZeroTilesX=n.defaultValue(e.numberOfLevelZeroTilesX,1),this._numberOfLevelZeroTilesY=n.defaultValue(e.numberOfLevelZeroTilesY,1),this._projection=new s.WebMercatorProjection(this._ellipsoid),i.defined(e.rectangleSouthwestInMeters)&&i.defined(e.rectangleNortheastInMeters))this._rectangleSouthwestInMeters=e.rectangleSouthwestInMeters,this._rectangleNortheastInMeters=e.rectangleNortheastInMeters;else{const e=this._ellipsoid.maximumRadius*Math.PI;this._rectangleSouthwestInMeters=new r.Cartesian2(-e,-e),this._rectangleNortheastInMeters=new r.Cartesian2(e,e)}const t=this._projection.unproject(this._rectangleSouthwestInMeters),l=this._projection.unproject(this._rectangleNortheastInMeters);this._rectangle=new r.Rectangle(t.longitude,t.latitude,l.longitude,l.latitude)}Object.defineProperties(w.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},rectangle:{get:function(){return this._rectangle}},projection:{get:function(){return this._projection}}}),w.prototype.getNumberOfXTilesAtLevel=function(e){return this._numberOfLevelZeroTilesX<<e},w.prototype.getNumberOfYTilesAtLevel=function(e){return this._numberOfLevelZeroTilesY<<e},w.prototype.rectangleToNativeRectangle=function(e,t){const n=this._projection,o=n.project(r.Rectangle.southwest(e)),s=n.project(r.Rectangle.northeast(e));return i.defined(t)?(t.west=o.x,t.south=o.y,t.east=s.x,t.north=s.y,t):new r.Rectangle(o.x,o.y,s.x,s.y)},w.prototype.tileXYToNativeRectangle=function(e,t,n,o){const s=this.getNumberOfXTilesAtLevel(n),l=this.getNumberOfYTilesAtLevel(n),a=(this._rectangleNortheastInMeters.x-this._rectangleSouthwestInMeters.x)/s,u=this._rectangleSouthwestInMeters.x+e*a,c=this._rectangleSouthwestInMeters.x+(e+1)*a,h=(this._rectangleNortheastInMeters.y-this._rectangleSouthwestInMeters.y)/l,f=this._rectangleNortheastInMeters.y-t*h,g=this._rectangleNortheastInMeters.y-(t+1)*h;return i.defined(o)?(o.west=u,o.south=g,o.east=c,o.north=f,o):new r.Rectangle(u,g,c,f)},w.prototype.tileXYToRectangle=function(e,t,n,i){const o=this.tileXYToNativeRectangle(e,t,n,i),s=this._projection,l=s.unproject(new r.Cartesian2(o.west,o.south)),a=s.unproject(new r.Cartesian2(o.east,o.north));return o.west=l.longitude,o.south=l.latitude,o.east=a.longitude,o.north=a.latitude,o},w.prototype.positionToTileXY=function(e,t,n){const o=this._rectangle;if(!r.Rectangle.contains(o,e))return;const s=this.getNumberOfXTilesAtLevel(t),l=this.getNumberOfYTilesAtLevel(t),a=(this._rectangleNortheastInMeters.x-this._rectangleSouthwestInMeters.x)/s,u=(this._rectangleNortheastInMeters.y-this._rectangleSouthwestInMeters.y)/l,c=this._projection.project(e);let h=(c.x-this._rectangleSouthwestInMeters.x)/a|0;h>=s&&(h=s-1);let f=(this._rectangleNortheastInMeters.y-c.y)/u|0;return f>=l&&(f=l-1),i.defined(n)?(n.x=h,n.y=f,n):new r.Cartesian2(h,f)};let m,M,z=65,v={},T=16,I=512,S=new c(100),N={};function j(t,r,n){let i=t.url,o=new e.Resource({url:i});o.request.throttle=!1,o.request.throttleByServer=!0,o.request.type=1;let s=o.fetchArrayBuffer();s?s.then(function(e,r){let i=l.decode(r),o=l.toRGBA8(i)[0],s=function(e,t){let r=new Int16Array(t*t);const n=t;for(let t=0;t<n;t++)for(let i=0;i<n;i++){const o=4*(t*n+i);r[t*n+i]=R(e[o],e[o+1],e[o+2])}return r}(new Uint8Array(o),i.width);t.xyz.z==T&&S.set(t.xyzStr,s);let u=b(s,i.width,n);a.updateElevation(v[m],m,t.xyzStr,s).then((function(t){e.resolve(u)}),(function(t){e.resolve(u)}))}.bind(this,r)):r.reject(null)}function b(e,t,r){let n=Math.floor(t/(z-1)),i=new Int16Array(z*z),o=1e4,s=-2e4;for(let r=0;r<z;r++){let l=r*n*t;r==z-1&&(l=t*t-t);let a=l+t-1;for(let t=0;t<z;t++){let u=t*n+l;t==z-1&&(u=a),i[t+r*z]=e[u],o>e[u]&&(o=e[u]),s<e[u]&&(s=e[u])}}return r.push(i.buffer),{sData:i,_minimumHeight:o,_maximumHeight:s}}function R(e,t,r){return Math.round((256*e*256+256*t+r)/10-1e4)}return f.createTaskProcessorWorker((function(e,r){if(1==e.init)return function(e){z=e.w,m=e.indexDbName,I=e.tileSize,M="GeographicTilingScheme"==e.tilingSchemeName?new t.GeographicTilingScheme:new w;return T=e.maxLevel,a.getDBMap([m],v)}(e);let n=h.defer();return e.xyzStr=e.xyz.x+"_"+e.xyz.y+"_"+e.xyz.z,a.getElevation(v,[m],e.xyzStr).then((function(t){for(let e in t){let i=t[e];if(i){let e=b(i.data,I,r);return void n.resolve(e)}}if(e.xyz.z>T)return function(e,t,r,n){let i=Math.pow(2,e.xyz.z-t),o={x:Math.floor(e.xyz.x/i),y:Math.floor(e.xyz.y/i),z:t},s=e.xyz,l=o.x+"_"+o.y+"_"+o.z,c=S.get(l);if(c){let t=u.upsample(M,c,I,I,o,s),i=b(t,I,n);a.updateElevation(v[m],m,e.xyzStr,t).finally((function(e){r.resolve(i)}))}else{let t=e.resourceUrl;if(t=t.replace("{x}",o.x),t=t.replace("{y}",o.y),t=t.replace("{z}",o.z),e.url=t,e.xyz=o,e.xyzStr=e.xyz.x+"_"+e.xyz.y+"_"+e.xyz.z,N[t])r.reject(null);else{let i=h.defer();j(e,i,n),N[t]=!0,i.promise.then((function(){let i=S.get(e.xyzStr),l=u.upsample(M,i,I,I,o,s),c=b(l,I,n),h=s.x+"_"+s.y+"_"+s.z;a.updateElevation(v[m],m,h,l).finally((function(e){delete N[t],r.resolve(c)}))}),(function(){delete N[t],r.reject(null)}))}}}(e,T,n,r),n.promise;j(e,n,r)})),n.promise}))}));
