define(["./createTaskProcessorWorker-03824364","./Resource-be841477","./Cartesian3-e96ac170","./HouseDrawer","./ParseBinaryData","./GetPrimitiveData","./ScanLine","./ElevationTool","./Cache","./defer-7878b392","./defaultValue-9f6a6288","./defined-64766648","./Math-56779564","./combine-ac72e009","./RuntimeError-cfbf2bc8","./Buffer","./base64","./ieee754","./isArray","./VarintReader","./snappyJs","./CodeTool","./GisTools","./VarintReaderV3","./ZstdLoader","./zstd_wasm","./Color-cad7c885","./Transforms-b1e48e05","./Ellipsoid-fa58f06f","./GeographicProjection-868b0b16","./Matrix3-59918a96","./Matrix2-e52b9454","./Cartesian2-0a34ed75","./ComponentDatatype-63fd8cd4","./WebGLConstants-7f557f93","./GeometryInstance-a555221e","./PolygonGeometry-9ef51ca3","./ArcType-26a3f38d","./BoundingRectangle-3100662d","./EllipsoidGeodesic-9e013872","./EllipsoidTangentPlane-8f36a7e0","./AxisAlignedBoundingBox-8b4e9f9c","./IntersectionTests-39c3b1c1","./Plane-f9bf6226","./Geometry-dd0ae099","./GeometryAttribute-5ac032ac","./GeometryOffsetAttribute-2579b8d2","./GeometryPipeline-92c34dd1","./AttributeCompression-44abee07","./EncodedCartesian3-e0f0a7d1","./IndexDatatype-ed8b21cb","./PolygonGeometryLibrary-37fe200f","./arrayRemoveDuplicates-d0608faf","./EllipsoidRhumbLine-cea00df6","./GeometryAttributes-3de79df5","./PolygonPipeline-d79010c3","./VertexFormat-01d05a0d","./PolygonOutlineGeometry-9f19e302","./Texture-3b0b528f","./PixelFormat-5109196d","./PrimitivePipeline-7bd2b931","./WebMercatorProjection-78306e76","./GetRidingLanternGeometry","./LinkedQueue"],(function(e,t,r,n,o,i,l,a,s,u,f,h,y,c,g,d,m,p,v,P,G,x,b,A,w,D,T,C,E,M,B,L,R,F,I,V,k,S,H,N,W,j,q,z,O,J,_,Q,U,Z,$,K,X,Y,ee,te,re,ne,oe,ie,le,ae,se,ue){"use strict";let fe,he,ye,ce={},ge=512,de={},me={},pe={},ve=new s(1e5);function Pe(e,t){if("F"!=e[0])if(Array.isArray(e[0])){let r=e.length;for(let n=0;n<r;n++){Pe(e[n],t)}}else t&&function(e){let t=[e[0],e[1]];for(let r=2;r<e.length;r++){let n=t[0]+e[r],o=t[1]+e[r+1];e[r]=n,e[r+1]=o,t=[n,o],r++}}(e);else e[0]=[.05*-ge,.05*-ge,1.05*ge,.05*-ge,1.05*ge,1.05*ge,.05*-ge,1.05*ge]}function Ge(e){let t=1e3,r=0;for(let n=0;n<e.length;n++){let o=e[n];for(let e=0;e<o.length-1;e++){let n=Math.round(o[e+1]);n<t&&(t=n),n>r&&(r=n),e++}}return{ymax:r,ymin:t}}function xe(e,t){if(Array.isArray(t[0])){let r=t.length;for(let n=0;n<r;n++){xe(e,t[n])}}else e.push(t)}function be(e,t){let n=t.rectangle;for(var o=[],i=0;i<e.length;i++){var l=Ae(e[i],e[i+1],n),a=r.Cartesian3.fromDegrees(l[0],l[1]);o.push(a),i++}return o}function Ae(e,t,r){var n=we(r.west+r.width/ge*e),o=we(r.north-r.height/ge*t);return[n=Number(n.toFixed(6)),o=Number(o.toFixed(6))]}function we(e){return 180*e/Math.PI}return e.createTaskProcessorWorker((async function(e,r){if(1==e.init)return void function(e){ye=new Function("render","level",e.styleStr),ge=e.tileSize,e.return_type,de=e,fe=e.indexDbNames,he=e.indexDbName,me=e.serverInfo,pe=e.layerFieldMap,a.getDBMap(fe,ce)}(e);var s=e.url,f=new t.Resource({url:s});f.request.throttle=!1,f.request.throttleByServer=!0,f.request.type=1;var h=f.fetchArrayBuffer();if(!h)return!0;let y=[];y.push(h);let c=fe.slice(0,fe.length-1);y.push(a.getElevation(ce,c,e.xyz));let g=u.defer();return Promise.all(y).then((async function(t){let s=t[0];if(!s)return void g.resolve({});let u=function(e,t){if(e){!function(e,t){for(let r in e){let n=e[r].features;n||(n=e[r].datas);for(let e=0;e<n.length;e++)Pe(n[e][2],t)}}(e,t.needDecode);let r={},o=new n([e],t.level,r,t.controlVector,t.highLightVector,t.filterLayerId);return ye.call({},o,t.level),function(e){for(let t in e){let r=e[t];for(let e=0;e<r.length;e++){let t=r[e],n=[];xe(n,t.data),delete t.data,t.geometrys=n;let o=0;if(de.hasOwnProperty("heightProperty")){let e=de.heightProperty;o=t.properties[e],de.hasOwnProperty("heightScale")&&(o*=parseFloat(de.heightScale))}t.height=o,t.totalHeight=o}}}(r),r}return{}}(await o(s,pe,me),e);de.hasTerrain&&function(e,t){var r=1e3,n=0;for(let o in e){let i=e[o];for(let e=0;e<i.length;e++){let o=i[e],l=-2e4,a=ve.get(o.properties.id);if(a)l=a;else{for(let e=0;e<o.geometrys.length;e++){let i=o.geometrys[e];for(let e=0;e<i.length-1;e++){let o=Math.round(i[e]),a=Math.round(i[e+1]);if(a<r&&(r=a),a>n&&(n=a),e++,o<0||o>ge-1||a<0||a>ge-1)continue;let s=a*ge+o,u=0;for(let e in t){u+=t[e].data[s]}u>l&&(l=u)}}-2e4==l&&(l=0),ve.set(o.properties.id,l)}o.terrainHeight=l,o.totalHeight=l+o.height}}}(u,t[1]);let f=function(e,t){let r=new Int32Array(t*t);for(let n in e){let o=e[n];for(let e=0;e<o.length;e++){let n=o[e],i=Ge(n.geometrys);l(r,n,t,i.ymax,i.ymin)}}return r}(u,ge);!function(e,t){for(let r in e){let n=e[r];for(let e=0;e<n.length;e++){let r=n[e];r.polygons=[];for(let e=0;e<r.geometrys.length;e++){let n=be(r.geometrys[e],t);r.polygons.push(n)}delete r.geometrys}}}(u,e);let h=i(u,e.level,de,r);a.updateElevation(ce[he],he,e.xyz,f).finally((function(e){g.resolve(h)}))}),(function(e){g.reject(e)})),g.promise}))}));
